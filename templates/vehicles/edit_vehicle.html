{% extends "base.html" %}
{% load static %}

{% block title %}ç¼–è¾‘è½¦è¾† - äºŒæ‰‹è½¦é›†å¸‚ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
.edit-form {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 30px;
}

.form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.form-section:last-child {
    border-bottom: none;
}

.section-title {
    font-size: 18px;
    font-weight: bold;
    color: #333;
    margin-bottom: 20px;
    padding-left: 10px;
    border-left: 4px solid #ff6b35;
}

.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
}

.form-group.half {
    flex: 0.5;
}

.form-label {
    display: block;
    font-weight: 500;
    margin-bottom: 8px;
    color: #555;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-control:focus {
    outline: none;
    border-color: #ff6b35;
    box-shadow: 0 0 0 2px rgba(255,107,53,0.1);
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

.image-upload-area {
    border: 2px dashed #ddd;
    border-radius: 6px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.3s;
}

.image-upload-area:hover {
    border-color: #ff6b35;
}

.image-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.image-item {
    position: relative;
    border-radius: 6px;
    overflow: hidden;
}

.image-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.image-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 12px;
}

.image-item.main .image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,107,53,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.btn {
    padding: 12px 30px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-primary {
    background: #ff6b35;
    color: white;
}

.btn-primary:hover {
    background: #e55a2b;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.button-group {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #ff6b35;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.alert {
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    display: none;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
{% endblock %}

{% block content %}
<div class="edit-form">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <h1 class="page-title">ç¼–è¾‘è½¦è¾†ä¿¡æ¯</h1>
        <p style="color: #666; margin-top: 10px;">ä¿®æ”¹æ‚¨çš„è½¦è¾†è¯¦ç»†ä¿¡æ¯</p>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div id="alert-container"></div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 10px;">æ­£åœ¨åŠ è½½è½¦è¾†ä¿¡æ¯...</p>
    </div>

    <!-- ç¼–è¾‘è¡¨å• -->
    <form id="edit-form" style="display: none;">
        <input type="hidden" id="vehicleId" value="{{ vehicle_id }}">

        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="form-section">
            <h3 class="section-title">åŸºæœ¬ä¿¡æ¯</h3>

            <div class="form-row">
                <div class="form-group half">
                    <label class="form-label">è½¦è¾†å“ç‰Œ <span class="text-danger">*</span></label>
                    <select class="form-control" id="brand" name="brand" required>
                        <option value="">è¯·é€‰æ‹©å“ç‰Œ</option>
                    </select>
                </div>
                <div class="form-group half">
                    <label class="form-label">è½¦è¾†ç±»å‹</label>
                    <select class="form-control" id="car_type" name="car_type">
                        <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">è½¦å‹åç§° <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="model_name" name="model_name"
                           placeholder="ä¾‹å¦‚ï¼šå¥¥è¿ªA4L 2023æ¬¾ 45 TFSI quattro" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group half">
                    <label class="form-label">å¹´ä»½ <span class="text-danger">*</span></label>
                    <select class="form-control" id="year" name="year" required>
                        <option value="">è¯·é€‰æ‹©å¹´ä»½</option>
                    </select>
                </div>
                <div class="form-group half">
                    <label class="form-label">è½¦èº«é¢œè‰² <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="color" name="color"
                           placeholder="ä¾‹å¦‚ï¼šç™½è‰²ã€é»‘è‰²ã€é“¶è‰²" required>
                </div>
            </div>
        </div>

        <!-- è½¦è¾†ä¿¡æ¯ -->
        <div class="form-section">
            <h3 class="section-title">è½¦è¾†ä¿¡æ¯</h3>

            <div class="form-row">
                <div class="form-group half">
                    <label class="form-label">å˜é€Ÿç®±</label>
                    <select class="form-control" id="transmission" name="transmission">
                        <option value="manual">æ‰‹åŠ¨</option>
                        <option value="auto" selected>è‡ªåŠ¨</option>
                        <option value="cvt">CVT</option>
                    </select>
                </div>
                <div class="form-group half">
                    <label class="form-label">ç‡ƒæ–™ç±»å‹</label>
                    <select class="form-control" id="fuel_type" name="fuel_type">
                        <option value="gasoline" selected>æ±½æ²¹</option>
                        <option value="diesel">æŸ´æ²¹</option>
                        <option value="electric">ç”µåŠ¨</option>
                        <option value="hybrid">æ··åˆåŠ¨åŠ›</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group half">
                    <label class="form-label">æ’æ”¾æ ‡å‡†</label>
                    <select class="form-control" id="emission_standard" name="emission_standard">
                        <option value="euro6" selected>å›½VI</option>
                        <option value="euro5">å›½V</option>
                        <option value="euro4">å›½IV</option>
                        <option value="euro3">å›½III</option>
                        <option value="euro2">å›½II</option>
                        <option value="euro1">å›½I</option>
                    </select>
                </div>
                <div class="form-group half">
                    <label class="form-label">è¡Œé©¶é‡Œç¨‹(å…¬é‡Œ) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="mileage" name="mileage"
                           placeholder="è¯·è¾“å…¥è¡Œé©¶é‡Œç¨‹å…¬é‡Œæ•°" min="0" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group half">
                    <label class="form-label">ä¸Šç‰Œæ—¶é—´ <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="plate_date" name="plate_date" required>
                </div>
                <div class="form-group half">
                    <label class="form-label">é¦–æ¬¡ä¸Šç‰Œæ—¶é—´</label>
                    <input type="date" class="form-control" id="first_owner_date" name="first_owner_date">
                </div>
            </div>
        </div>

        <!-- ä»·æ ¼ä¿¡æ¯ -->
        <div class="form-section">
            <h3 class="section-title">ä»·æ ¼ä¿¡æ¯</h3>

            <div class="form-row">
                <div class="form-group half">
                    <label class="form-label">å”®ä»·(å…ƒ) <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="price" name="price"
                           placeholder="è¯·è¾“å…¥å”®ä»·é‡‘é¢" min="0" step="100" required>
                </div>
                <div class="form-group half">
                    <label class="form-label">VINç <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="vin" name="vin"
                           placeholder="è¯·è¾“å…¥17ä½VINç " maxlength="17" required>
                </div>
            </div>
        </div>

        <!-- è½¦å†µæè¿° -->
        <div class="form-section">
            <h3 class="section-title">è½¦å†µæè¿°</h3>

            <div class="form-group">
                <label class="form-label">è½¦è¾†æè¿° <span class="text-danger">*</span></label>
                <textarea class="form-control" id="description" name="description"
                          placeholder="è¯·è¯¦ç»†æè¿°è½¦è¾†çš„è½¦å†µã€é…ç½®ã€ä¿å…»æƒ…å†µç­‰ä¿¡æ¯" required></textarea>
            </div>
        </div>

        <!-- è½¦è¾†å›¾ç‰‡ -->
        <div class="form-section">
            <h3 class="section-title">è½¦è¾†å›¾ç‰‡</h3>

            <div class="image-upload-area" id="imageUploadArea">
                <div style="font-size: 48px; color: #ddd; margin-bottom: 10px;">ğŸ“·</div>
                <p>ç‚¹å‡»ä¸Šä¼ è½¦è¾†å›¾ç‰‡</p>
                <p style="font-size: 12px; color: #999;">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®ä¸Šä¼ å¤šè§’åº¦ç…§ç‰‡</p>
                <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
            </div>

            <div class="image-preview" id="imagePreview">
                <!-- ç°æœ‰å›¾ç‰‡å’Œæ–°å¢å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- æäº¤æŒ‰é’® -->
        <div class="button-group">
            <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            <a href="/seller-center/#vehicles" class="btn btn-secondary">å–æ¶ˆ</a>
            <button type="button" class="btn btn-danger" id="deleteBtn">åˆ é™¤è½¦è¾†</button>
        </div>
    </form>
</div>

<script>
let vehicleData = {};
let uploadedImages = [];
let existingImages = [];

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
});

// åˆå§‹åŒ–é¡µé¢
async function initializePage() {
    await loadVehicleData();
    await initializeBrands();
    await initializeYears();
    setupImageUpload();
    setupFormSubmit();
    setupDeleteButton();
}

// åŠ è½½è½¦è¾†æ•°æ®
async function loadVehicleData() {
    try {
        const vehicleId = document.getElementById('vehicleId').value;
        const token = localStorage.getItem('accessToken');

        console.log('æ­£åœ¨åŠ è½½è½¦è¾†æ•°æ®ï¼ŒID:', vehicleId);
        console.log('Tokenå­˜åœ¨:', !!token);

        if (!token) {
            throw new Error('è¯·å…ˆç™»å½•åå†ç¼–è¾‘è½¦è¾†');
        }

        // å°è¯•å¤šä¸ªå¯èƒ½çš„APIç«¯ç‚¹
        const apiEndpoints = [
            `/api/vehicles/${vehicleId}/`,
            `/api/seller/vehicles/${vehicleId}/`,
            `/api/vehicles/my_vehicles/${vehicleId}/`
        ];

        let response = null;
        let workingEndpoint = null;

        for (const endpoint of apiEndpoints) {
            try {
                console.log(`å°è¯•APIç«¯ç‚¹: ${endpoint}`);
                response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    workingEndpoint = endpoint;
                    console.log(`æˆåŠŸä½¿ç”¨ç«¯ç‚¹: ${endpoint}`);
                    break;
                } else {
                    console.warn(`ç«¯ç‚¹ ${endpoint} è¿”å›çŠ¶æ€: ${response.status}`);
                }
            } catch (endpointError) {
                console.warn(`ç«¯ç‚¹ ${endpoint} è¯·æ±‚å¤±è´¥:`, endpointError);
                continue;
            }
        }

        if (!response || !response.ok) {
            throw new Error(`æ— æ³•è®¿é—®è½¦è¾†æ•°æ®ï¼Œè¯·æ£€æŸ¥æƒé™å’Œç½‘ç»œè¿æ¥`);
        }

        vehicleData = await response.json();
        console.log('æˆåŠŸåŠ è½½è½¦è¾†æ•°æ®:', vehicleData);

        // æ£€æŸ¥æ•°æ®ç»“æ„å’Œæƒé™
        if (!vehicleData || !vehicleData.id) {
            throw new Error('è¿”å›çš„è½¦è¾†æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯è½¦è¾†æ‰€æœ‰è€…
        if (vehicleData.seller && vehicleData.seller !== getCurrentUserId()) {
            console.warn('è­¦å‘Šï¼šæ‚¨å¯èƒ½ä¸æ˜¯æ­¤è½¦è¾†çš„æ‰€æœ‰è€…');
        }

        // å¡«å……è¡¨å•æ•°æ®
        fillFormData();

        // æ˜¾ç¤ºè¡¨å•
        document.getElementById('loading').style.display = 'none';
        document.getElementById('edit-form').style.display = 'block';

    } catch (error) {
        console.error('åŠ è½½è½¦è¾†æ•°æ®å¤±è´¥:', error);
        showAlert('åŠ è½½è½¦è¾†æ•°æ®å¤±è´¥: ' + error.message, 'error');

        // æ˜¾ç¤ºé‡è¯•æŒ‰é’®
        document.getElementById('loading').innerHTML = `
            <div class="alert alert-error" style="display: block;">
                <h4>åŠ è½½å¤±è´¥</h4>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="location.reload()">é‡æ–°åŠ è½½</button>
                <a href="/seller-center/#vehicles" class="btn btn-secondary">è¿”å›è½¦è¾†åˆ—è¡¨</a>
            </div>
        `;
    }
}

// è·å–å½“å‰ç”¨æˆ·ID
function getCurrentUserId() {
    // ä»localStorageæˆ–å…¶ä»–åœ°æ–¹è·å–ç”¨æˆ·ä¿¡æ¯
    const userInfo = localStorage.getItem('userInfo');
    if (userInfo) {
        try {
            const user = JSON.parse(userInfo);
            return user.id;
        } catch (e) {
            console.warn('æ— æ³•è§£æç”¨æˆ·ä¿¡æ¯');
        }
    }
    return null;
}

// å¡«å……è¡¨å•æ•°æ®
function fillFormData() {
    console.log('å¡«å……è¡¨å•æ•°æ®:', vehicleData);

    // å¤„ç†å“ç‰Œæ•°æ® (å¯èƒ½æ˜¯å¯¹è±¡æˆ–ID)
    const brandId = vehicleData.brand?.id || vehicleData.brand || '';
    document.getElementById('brand').value = brandId;
    console.log('è®¾ç½®å“ç‰Œ:', brandId);

    // å¤„ç†è½¦å‹æ•°æ® (å¯èƒ½æ˜¯å¯¹è±¡æˆ–ID)
    const carTypeId = vehicleData.car_type?.id || vehicleData.car_type || '';
    document.getElementById('car_type').value = carTypeId;

    document.getElementById('model_name').value = vehicleData.model_name || '';
    document.getElementById('year').value = vehicleData.year || '';
    document.getElementById('color').value = vehicleData.color || '';
    document.getElementById('transmission').value = vehicleData.transmission || 'auto';
    document.getElementById('fuel_type').value = vehicleData.fuel_type || 'gasoline';
    document.getElementById('emission_standard').value = vehicleData.emission_standard || 'euro5';
    document.getElementById('mileage').value = vehicleData.mileage || '';
    document.getElementById('plate_date').value = vehicleData.plate_date || '';
    document.getElementById('first_owner_date').value = vehicleData.first_owner_date || '';
    document.getElementById('price').value = vehicleData.price || '';
    document.getElementById('vin').value = vehicleData.vin || '';
    document.getElementById('description').value = vehicleData.description || '';

    // æ˜¾ç¤ºç°æœ‰å›¾ç‰‡
    if (vehicleData.photos && vehicleData.photos.length > 0) {
        console.log('æ˜¾ç¤ºç°æœ‰å›¾ç‰‡:', vehicleData.photos);
        displayExistingImages(vehicleData.photos);
    }

    console.log('è¡¨å•æ•°æ®å¡«å……å®Œæˆ');
}

// æ˜¾ç¤ºç°æœ‰å›¾ç‰‡
function displayExistingImages(photos) {
    const imagePreview = document.getElementById('imagePreview');

    photos.forEach((photo, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = `image-item ${photo.is_main ? 'main' : ''}`;
        imageItem.dataset.imageId = photo.id;

        imageItem.innerHTML = `
            <img src="${photo.image}" alt="è½¦è¾†å›¾ç‰‡${index + 1}">
            <button type="button" class="image-remove" onclick="removeExistingImage(${photo.id})">Ã—</button>
            ${photo.is_main ? '<div class="image-overlay">ä¸»å›¾</div>' : ''}
        `;

        imagePreview.appendChild(imageItem);
        existingImages.push(photo);
    });
}

// åˆå§‹åŒ–å“ç‰Œä¸‹æ‹‰é€‰æ‹©
async function initializeBrands() {
    try {
        const response = await fetch('/api/vehicles/brands/');
        if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
        const data = await response.json();

        const brandSelect = document.getElementById('brand');

        // å¤„ç†å¯èƒ½çš„ä¸åŒAPIè¿”å›æ ¼å¼
        const brands = Array.isArray(data) ? data : (data.results || []);

        if (brands.length === 0) {
            console.warn('å“ç‰Œåˆ—è¡¨ä¸ºç©º');
            return;
        }

        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand.id;
            option.textContent = brand.name;
            brandSelect.appendChild(option);
        });

        console.log(`æˆåŠŸåŠ è½½ ${brands.length} ä¸ªå“ç‰Œ`);

        // å“ç‰Œé€‰æ‹©å˜åŒ–æ—¶åŠ è½½è½¦å‹
        brandSelect.addEventListener('change', loadCarTypes);

    } catch (error) {
        console.error('åŠ è½½å“ç‰Œå¤±è´¥:', error);
        const brandSelect = document.getElementById('brand');
        brandSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        showAlert('åŠ è½½å“ç‰Œå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    }
}

// åŠ è½½è½¦å‹
async function loadCarTypes() {
    const brandId = document.getElementById('brand').value;
    const carTypeSelect = document.getElementById('car_type');

    // æ¸…ç©ºå½“å‰é€‰é¡¹
    carTypeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç±»å‹</option>';

    if (!brandId) return;

    try {
        const response = await fetch('/api/vehicles/types/');
        const data = await response.json();

        const types = Array.isArray(data) ? data : (data.results || []);

        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            carTypeSelect.appendChild(option);
        });

    } catch (error) {
        console.error('åŠ è½½è½¦å‹å¤±è´¥:', error);
    }
}

// åˆå§‹åŒ–å¹´ä»½
function initializeYears() {
    const yearSelect = document.getElementById('year');
    const currentYear = new Date().getFullYear();

    for (let year = currentYear; year >= 1990; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + 'å¹´';
        yearSelect.appendChild(option);
    }
}

// è®¾ç½®å›¾ç‰‡ä¸Šä¼ 
function setupImageUpload() {
    const uploadArea = document.getElementById('imageUploadArea');
    const imageInput = document.getElementById('imageInput');

    uploadArea.addEventListener('click', () => {
        imageInput.click();
    });

    imageInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);

        files.forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    addImageToPreview(e.target.result, file);
                };

                reader.readAsDataURL(file);
            }
        });

        // æ¸…ç©ºinputä»¥ä¾¿é‡æ–°é€‰æ‹©ç›¸åŒæ–‡ä»¶
        e.target.value = '';
    });
}

// æ·»åŠ å›¾ç‰‡åˆ°é¢„è§ˆ
function addImageToPreview(imageSrc, file) {
    const imagePreview = document.getElementById('imagePreview');

    const imageItem = document.createElement('div');
    imageItem.className = 'image-item';

    const imageId = 'new-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    imageItem.dataset.imageId = imageId;

    imageItem.innerHTML = `
        <img src="${imageSrc}" alt="è½¦è¾†å›¾ç‰‡">
        <button type="button" class="image-remove" onclick="removeNewImage('${imageId}')">Ã—</button>
    `;

    imagePreview.appendChild(imageItem);

    uploadedImages.push({
        id: imageId,
        file: file,
        src: imageSrc
    });
}

// ç§»é™¤æ–°ä¸Šä¼ çš„å›¾ç‰‡
function removeNewImage(imageId) {
    const imageItem = document.querySelector(`[data-image-id="${imageId}"]`);
    if (imageItem) {
        imageItem.remove();
        uploadedImages = uploadedImages.filter(img => img.id !== imageId);
    }
}

// ç§»é™¤ç°æœ‰å›¾ç‰‡
function removeExistingImage(imageId) {
    const imageItem = document.querySelector(`[data-image-id="${imageId}"]`);
    if (imageItem) {
        imageItem.remove();
        existingImages = existingImages.filter(img => img.id !== imageId);
    }
}

// è®¾ç½®è¡¨å•æäº¤
function setupFormSubmit() {
    const form = document.getElementById('edit-form');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        await submitForm();
    });
}

// è¡¨å•éªŒè¯
function validateForm() {
    const requiredFields = ['brand', 'model_name', 'year', 'color', 'mileage', 'plate_date', 'price', 'vin', 'description'];

    for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.focus();
            showAlert(`è¯·å¡«å†™${field.previousElementSibling.textContent.replace('*', '').trim()}`, 'error');
            return false;
        }
    }

    return true;
}

// æäº¤è¡¨å•
async function submitForm() {
    try {
        const vehicleId = document.getElementById('vehicleId').value;
        const token = localStorage.getItem('accessToken');

        console.log('å¼€å§‹æäº¤è¡¨å•ï¼Œè½¦è¾†ID:', vehicleId);
        console.log('Tokenå­˜åœ¨:', !!token);

        if (!token) {
            throw new Error('è¯·å…ˆç™»å½•åå†ä¿å­˜ä¿®æ”¹');
        }

        // åˆ›å»ºFormData
        const formData = new FormData();

        // æ·»åŠ è¡¨å•å­—æ®µ
        const brandValue = document.getElementById('brand').value;
        const carTypeValue = document.getElementById('car_type').value || '';
        const modelNameValue = document.getElementById('model_name').value;
        const yearValue = document.getElementById('year').value;
        const colorValue = document.getElementById('color').value;
        const transmissionValue = document.getElementById('transmission').value;
        const fuelTypeValue = document.getElementById('fuel_type').value;
        const emissionStandardValue = document.getElementById('emission_standard').value;
        const mileageValue = document.getElementById('mileage').value;
        const plateDateValue = document.getElementById('plate_date').value;
        const firstOwnerDateValue = document.getElementById('first_owner_date').value;
        const priceValue = document.getElementById('price').value;
        const vinValue = document.getElementById('vin').value;
        const descriptionValue = document.getElementById('description').value;

        console.log('è¡¨å•æ•°æ®:', {
            brand: brandValue,
            model_name: modelNameValue,
            price: priceValue
        });

        formData.append('brand', brandValue);
        formData.append('car_type', carTypeValue);
        formData.append('model_name', modelNameValue);
        formData.append('year', yearValue);
        formData.append('color', colorValue);
        formData.append('transmission', transmissionValue);
        formData.append('fuel_type', fuelTypeValue);
        formData.append('emission_standard', emissionStandardValue);
        formData.append('mileage', mileageValue);
        formData.append('plate_date', plateDateValue);
        formData.append('first_owner_date', firstOwnerDateValue);
        formData.append('price', priceValue);
        formData.append('vin', vinValue);
        formData.append('description', descriptionValue);

        // æ·»åŠ æ–°ä¸Šä¼ çš„å›¾ç‰‡
        uploadedImages.forEach(img => {
            formData.append('images', img.file);
        });

        // å°è¯•å¤šä¸ªå¯èƒ½çš„APIç«¯ç‚¹è¿›è¡Œæ›´æ–°
        const apiEndpoints = [
            `/api/vehicles/${vehicleId}/`,
            `/api/seller/vehicles/${vehicleId}/`
        ];

        let response = null;
        let workingEndpoint = null;

        for (const endpoint of apiEndpoints) {
            try {
                console.log(`å°è¯•æ›´æ–°APIç«¯ç‚¹: ${endpoint}`);

                // åˆ›å»ºæ–°çš„FormDataå¯¹è±¡ï¼ˆå› ä¸ºFormDataåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼‰
                const updateFormData = new FormData();
                for (let [key, value] of formData.entries()) {
                    updateFormData.append(key, value);
                }

                response = await fetch(endpoint, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: updateFormData
                });

                if (response.ok || response.status === 400) {
                    workingEndpoint = endpoint;
                    console.log(`ä½¿ç”¨ç«¯ç‚¹: ${endpoint}`);
                    break;
                } else {
                    console.warn(`ç«¯ç‚¹ ${endpoint} è¿”å›çŠ¶æ€: ${response.status}`);
                }
            } catch (endpointError) {
                console.warn(`ç«¯ç‚¹ ${endpoint} è¯·æ±‚å¤±è´¥:`, endpointError);
                continue;
            }
        }

        console.log('æœ€ç»ˆAPIå“åº”çŠ¶æ€:', response.status);

        let result;
        try {
            result = await response.json();
            console.log('APIå“åº”æ•°æ®:', result);
        } catch (e) {
            console.log('APIå“åº”ä¸æ˜¯JSONæ ¼å¼');
            result = { detail: response.statusText };
        }

        if (response.ok) {
            showAlert('è½¦è¾†ä¿¡æ¯æ›´æ–°æˆåŠŸï¼', 'success');
            console.log('æ›´æ–°æˆåŠŸï¼Œå³å°†è·³è½¬');

            // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
            setTimeout(() => {
                window.location.href = '/seller-center/#vehicles';
            }, 2000);
        } else {
            let errorMessage = 'æ›´æ–°å¤±è´¥';
            if (result.detail) {
                errorMessage += ': ' + result.detail;
            } else if (result.error) {
                errorMessage += ': ' + result.error;
            } else if (response.status === 403) {
                errorMessage += ': æ‚¨æ²¡æœ‰æƒé™ç¼–è¾‘æ­¤è½¦è¾†';
            } else if (response.status === 404) {
                errorMessage += ': è½¦è¾†ä¸å­˜åœ¨';
            } else if (response.status === 400) {
                // æ˜¾ç¤ºéªŒè¯é”™è¯¯è¯¦æƒ…
                if (typeof result === 'object') {
                    const errors = Object.entries(result).map(([field, messages]) => {
                        const fieldName = document.querySelector(`[name="${field}"]`)?.previousElementSibling?.textContent || field;
                        return `${fieldName}: ${Array.isArray(messages) ? messages.join(', ') : messages}`;
                    });
                    errorMessage += ':\\n' + errors.join('\\n');
                }
            } else {
                errorMessage += ': æœªçŸ¥é”™è¯¯ (çŠ¶æ€ç : ' + response.status + ')';
            }

            showAlert(errorMessage, 'error');
            console.error('æ›´æ–°å¤±è´¥:', result);
        }

    } catch (error) {
        console.error('æäº¤å¤±è´¥:', error);
        showAlert('æäº¤å¤±è´¥: ' + error.message, 'error');
    }
}

// è®¾ç½®åˆ é™¤æŒ‰é’®
function setupDeleteButton() {
    const deleteBtn = document.getElementById('deleteBtn');

    deleteBtn.addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™è¾†è½¦å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
            deleteVehicle();
        }
    });
}

// åˆ é™¤è½¦è¾†
async function deleteVehicle() {
    try {
        const vehicleId = document.getElementById('vehicleId').value;
        const token = localStorage.getItem('accessToken');

        const response = await fetch(`/api/vehicles/${vehicleId}/`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            showAlert('è½¦è¾†åˆ é™¤æˆåŠŸ', 'success');
            setTimeout(() => {
                window.location.href = '/seller-center/#vehicles';
            }, 2000);
        } else {
            const result = await response.json();
            showAlert('åˆ é™¤å¤±è´¥: ' + (result.detail || result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }

    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        showAlert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;

    // å¤„ç†å¤šè¡Œé”™è¯¯æ¶ˆæ¯
    if (message.includes('\\n')) {
        const lines = message.split('\\n');
        alert.innerHTML = lines.map(line => `<div>${line}</div>`).join('');
    } else {
        alert.textContent = message;
    }

    alert.style.display = 'block';
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alert);

    // 5ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        alert.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}