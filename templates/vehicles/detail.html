{% extends "base.html" %}

{% block title %}è½¦è¾†è¯¦æƒ… - äºŒæ‰‹è½¦é›†å¸‚{% endblock %}

{% block content %}
<div class="container">
    <div id="vehicle-detail-container"></div>
</div>

<script>
// ä»URLè·¯å¾„ä¸­è·å–è½¦è¾†IDï¼Œä¾‹å¦‚ /vehicles/123/
const pathParts = window.location.pathname.split('/').filter(p => p);
const vehicleId = pathParts[pathParts.length - 1]; // è·å–æœ€åä¸€éƒ¨åˆ†ä½œä¸ºID

/**
 * è®°å½•ç”¨æˆ·æµè§ˆå†å²
 * å½“ç”¨æˆ·è®¿é—®è½¦è¾†è¯¦æƒ…é¡µæ—¶ï¼Œè‡ªåŠ¨è®°å½•ä¸€æ¡æµè§ˆè®°å½•
 */
async function recordBrowsingHistory() {
    try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        if (!API.Auth.isAuthenticated()) {
            console.log('ç”¨æˆ·æœªç™»å½•ï¼Œä¸è®°å½•æµè§ˆå†å²');
            return;
        }

        const token = API.Auth.getToken();
        const response = await fetch('/api/users/browsing-history/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                vehicle_id: parseInt(vehicleId)
            })
        });

        if (response.ok) {
            console.log('æµè§ˆå†å²è®°å½•æˆåŠŸ');
        } else {
            console.error('è®°å½•æµè§ˆå†å²å¤±è´¥:', response.status);
        }
    } catch (error) {
        console.error('è®°å½•æµè§ˆå†å²å‡ºé”™:', error);
    }
}

async function loadVehicleDetail() {
    if (!vehicleId || isNaN(vehicleId)) {
        document.getElementById('vehicle-detail-container').innerHTML = `
            <div style="text-align: center; padding: 50px; color: #999;">
                <p style="font-size: 18px; margin-bottom: 10px;">æ— æ•ˆçš„è½¦è¾†IDæˆ–å‚æ•°é”™è¯¯</p>
                <a href="/vehicles/" style="color: #007BFF;">è¿”å›è½¦è¾†åˆ—è¡¨</a>
            </div>
        `;
        return;
    }

    try {
        // è·å–è½¦è¾†è¯¦æƒ…ä¿¡æ¯
        const vehicle = await API.VehicleManager.getVehicle(vehicleId);
        const container = document.getElementById('vehicle-detail-container');

        const htmlContent = `
            <div class="vehicle-detail-container" style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 20px;">
                <div class="vehicle-main-info">
                    <div class="vehicle-images">
                        <img src="${vehicle.photos && vehicle.photos.length > 0 ? vehicle.photos[0].image : '/static/images/placeholder.png'}"
                             style="width: 100%; border-radius: 8px; margin-bottom: 20px; height: 400px; object-fit: cover;">
                    </div>

                    <div class="vehicle-header" style="margin-bottom: 20px;">
                        <h1 style="color: #333; margin-bottom: 10px;">${vehicle.brand_name} ${vehicle.model_name} ${vehicle.year}æ¬¾</h1>
                        <p style="color: #666; font-size: 16px;">${vehicle.year}å¹´ | ${vehicle.mileage ? vehicle.mileage.toLocaleString() : 'æœªçŸ¥'}å…¬é‡Œ | ${vehicle.color || 'æœªçŸ¥é¢œè‰²'}</p>
                    </div>

                    <div class="vehicle-price" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h2 style="margin: 0; font-size: 32px;">Â¥${vehicle.price ? vehicle.price.toLocaleString('zh-CN') : 'é¢è®®'}</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">å–å®¶è¦ä»·</p>
                    </div>

                    <div class="vehicle-specs" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">è½¦è¾†åŸºæœ¬ä¿¡æ¯</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold; width: 120px;">å“ç‰Œå‹å·</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${vehicle.brand_name} ${vehicle.model_name}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">å¹´ä»½</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${vehicle.year}å¹´</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">é‡Œç¨‹æ•°</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${vehicle.mileage ? vehicle.mileage.toLocaleString() + 'å…¬é‡Œ' : 'æœªçŸ¥'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">é¢œè‰²</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${vehicle.color || 'æœªçŸ¥'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">è½¦è¾†çŠ¶æ€</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">
                                    <span class="status-badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                        ${vehicle.status === 'sale' ? 'åœ¨å”®' : vehicle.status === 'sold' ? 'å·²å”®' : 'å…¶ä»–'}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div class="vehicle-description" style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: #333;">è½¦è¾†æè¿°</h3>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; line-height: 1.6;">
                            ${vehicle.description || 'æš‚æ— è¯¦ç»†æè¿°'}
                        </div>
                    </div>

                    <div class="ai-description-analysis" id="ai-description-analysis" style="margin-bottom: 30px; display: none;">
                        <h3 style="margin-bottom: 15px; color: #333;">ğŸ¤– AIæè¿°åˆ†æ</h3>
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <div id="ai-analysis-content"></div>
                        </div>
                    </div>
                </div>

                <div class="vehicle-sidebar">
                    <div class="contact-seller" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-top: 0; margin-bottom: 15px; color: #333;">è”ç³»å–å®¶</h3>
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="contactSeller()">
                            ğŸ“§ å‘é€æ¶ˆæ¯
                        </button>
                        <button class="btn btn-success" style="width: 100%;" onclick="buyNow()">
                            ğŸ›’ ç«‹å³è´­ä¹°
                        </button>
                    </div>

                    <div class="ai-price-estimate" id="ai-price-estimate" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-top: 0; margin-bottom: 15px; color: #333;">ğŸ¤– AIæ™ºèƒ½ä¼°ä»·</h3>
                        <button class="btn btn-info" style="width: 100%; margin-bottom: 15px;" onclick="getAIPriceEstimate()">
                            è·å–AIä¼°ä»·å»ºè®®
                        </button>
                        <div id="ai-price-content" style="display: none;">
                            <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                                <p style="margin-top: 10px; color: #666;">AIæ­£åœ¨åˆ†æ...</p>
                            </div>
                        </div>
                        <div id="ai-price-result" style="display: none;"></div>
                    </div>

                    <div class="ai-chat-assistant" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-top: 0; margin-bottom: 15px; color: #333;">ğŸ¤– AIè´­è½¦åŠ©æ‰‹</h3>
                        <div id="chat-messages" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 10px; background: #f8f9fa; border-radius: 4px;">
                            <div style="text-align: center; color: #666; padding: 20px;">
                                ğŸ¤– æ‚¨å¥½ï¼æˆ‘æ˜¯AIè´­è½¦åŠ©æ‰‹ï¼Œæœ‰ä»»ä½•å…³äºè½¦è¾†çš„é—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦ï¼
                            </div>
                        </div>
                        <div style="display: flex;">
                            <input type="text" id="chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." style="flex: 1; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px 0 0 4px; border-right: none;">
                            <button onclick="sendChatMessage()" style="padding: 8px 15px; background: #007bff; color: white; border: 1px solid #007bff; border-radius: 0 4px 4px 0; cursor: pointer;">
                                å‘é€
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = htmlContent;

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .status-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: bold;
            }
            .chat-message {
                margin-bottom: 10px;
                padding: 8px 12px;
                border-radius: 8px;
                max-width: 80%;
            }
            .chat-message.user {
                background: #007bff;
                color: white;
                margin-left: auto;
                text-align: right;
            }
            .chat-message.assistant {
                background: #e9ecef;
                color: #333;
            }
        `;
        document.head.appendChild(style);

        // è‡ªåŠ¨è§¦å‘AIæè¿°åˆ†æ
        if (vehicle.description && vehicle.description.length > 50) {
            setTimeout(() => analyzeDescription(vehicle.description), 1000);
        }

    } catch (error) {
        console.error('Load vehicle detail error:', error);
        API.Utils.showAlert('åŠ è½½è½¦è¾†è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
    }
}

async function getAIPriceEstimate() {
    const contentDiv = document.getElementById('ai-price-content');
    const resultDiv = document.getElementById('ai-price-result');

    contentDiv.style.display = 'block';
    resultDiv.style.display = 'none';

    try {
        const result = await API.AIManager.getPriceEstimate(vehicleId);

        if (result.success) {
            const estimation = result.price_estimation;
            contentDiv.style.display = 'none';
            resultDiv.style.display = 'block';

            resultDiv.innerHTML = `
                <div style="text-align: center;">
                    <h4 style="color: #28a745; margin-bottom: 10px;">AIä¼°ä»·å»ºè®®</h4>
                    <div style="font-size: 24px; font-weight: bold; color: #007bff; margin-bottom: 10px;">
                        Â¥${estimation.suggested_price ? parseFloat(estimation.suggested_price).toLocaleString('zh-CN') : 'åˆ†æä¸­...'}
                    </div>
                    ${estimation.min_price && estimation.max_price ? `
                        <div style="color: #666; margin-bottom: 10px;">
                            å»ºè®®ä»·æ ¼èŒƒå›´: Â¥${parseFloat(estimation.min_price).toLocaleString('zh-CN')} - Â¥${parseFloat(estimation.max_price).toLocaleString('zh-CN')}
                        </div>
                    ` : ''}
                    <div style="font-size: 12px; color: #666; margin-top: 10px;">
                        ç½®ä¿¡åº¦: ${Math.round((estimation.confidence || 0.8) * 100)}%
                    </div>
                    ${estimation.analysis ? `
                        <div style="text-align: left; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 14px; line-height: 1.5;">
                            <strong>AIåˆ†æ:</strong><br>
                            ${estimation.analysis}
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            throw new Error(result.error || 'è·å–ä¼°ä»·å¤±è´¥');
        }
    } catch (error) {
        console.error('AI price estimate error:', error);
        contentDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="text-align: center; color: #dc3545; padding: 10px;">
                âš ï¸ ${error.message || 'AIä¼°ä»·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•'}
            </div>
        `;
    }
}

async function analyzeDescription(description) {
    try {
        const result = await API.AIManager.analyzeDescription(description);

        if (result.success) {
            const analysisDiv = document.getElementById('ai-description-analysis');
            const contentDiv = document.getElementById('ai-analysis-content');

            analysisDiv.style.display = 'block';
            contentDiv.innerHTML = `
                <div style="line-height: 1.6;">${result.analysis}</div>
            `;
        }
    } catch (error) {
        console.error('Description analysis error:', error);
    }
}

let conversationHistory = [];

async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const messagesDiv = document.getElementById('chat-messages');
    const message = input.value.trim();

    if (!message) return;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMessage = document.createElement('div');
    userMessage.className = 'chat-message user';
    userMessage.textContent = message;
    messagesDiv.appendChild(userMessage);

    input.value = '';
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // æ·»åŠ AIå›å¤åŠ è½½çŠ¶æ€
    const aiMessagePlaceholder = document.createElement('div');
    aiMessagePlaceholder.className = 'chat-message assistant';
    aiMessagePlaceholder.innerHTML = '<div class="spinner" style="border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;"></div> æ­£åœ¨å›å¤...';
    messagesDiv.appendChild(aiMessagePlaceholder);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    try {
        const result = await API.AIManager.chatWithAI(message, conversationHistory);

        if (result.success) {
            conversationHistory = result.conversation_history;

            // æ›¿æ¢åŠ è½½çŠ¶æ€ä¸ºå®é™…å›å¤
            aiMessagePlaceholder.innerHTML = result.ai_response;
        } else {
            aiMessagePlaceholder.innerHTML = 'æŠ±æ­‰ï¼Œæ— æ³•ç†è§£æ‚¨çš„é—®é¢˜ï¼Œè¯·æ¢ç§æ–¹å¼æé—®';
        }
    } catch (error) {
        console.error('Chat error:', error);
        aiMessagePlaceholder.innerHTML = 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
    }

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function contactSeller() {
    if (!API.Auth.isAuthenticated()) {
        API.Utils.showAlert('è¯·å…ˆç™»å½•åå†è”ç³»å–å®¶', 'info');
        setTimeout(() => {
            window.location.href = '/login/';
        }, 1000);
        return;
    }
    API.Utils.showAlert('æ¶ˆæ¯åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…', 'info');
}

function buyNow() {
    console.log('=== ç«‹å³è´­ä¹°æŒ‰é’®è¢«ç‚¹å‡» ===');
    console.log('APIå¯¹è±¡:', API);
    console.log('API.Auth:', API && API.Auth);

    // æ£€æŸ¥APIå’ŒAuthå¯¹è±¡æ˜¯å¦å­˜åœ¨
    if (!API || !API.Auth) {
        console.error('APIå¯¹è±¡æˆ–API.Authä¸å­˜åœ¨');
        API.Utils.showAlert('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return;
    }

    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    const isAuth = API.Auth.isAuthenticated();
    const token = API.Auth.getToken();

    console.log('è®¤è¯çŠ¶æ€:', isAuth);
    console.log('Tokenå­˜åœ¨:', !!token);
    console.log('Tokenå†…å®¹:', token ? token.substring(0, 20) + '...' : 'null');

    if (!isAuth || !token) {
        console.log('ç”¨æˆ·æœªè®¤è¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
        API.Utils.showAlert('è¯·å…ˆç™»å½•åå†è´­ä¹°', 'info');
        setTimeout(() => {
            // è·³è½¬åˆ°ç™»å½•é¡µé¢è€Œä¸æ˜¯é¦–é¡µ
            window.location.href = '/login/';
        }, 1000);
        return;
    }

    // åˆ›å»ºè´­ä¹°è®¢å•é¡µé¢è·³è½¬
    const vehicleId = getVehicleIdFromUrl();
    console.log('è·å–åˆ°çš„è½¦è¾†ID:', vehicleId);

    if (!vehicleId) {
        console.error('æ— æ³•è·å–è½¦è¾†ID');
        API.Utils.showAlert('æ— æ•ˆçš„è½¦è¾†IDï¼Œè¯·è¿”å›è½¦è¾†åˆ—è¡¨é‡è¯•', 'error');
        return;
    }

    console.log('è·³è½¬åˆ°è®¢å•åˆ›å»ºé¡µé¢:', `/orders/create/${vehicleId}/`);
    window.location.href = `/orders/create/${vehicleId}/`;
}

// ä»URLä¸­è·å–è½¦è¾†ID
function getVehicleIdFromUrl() {
    const pathParts = window.location.pathname.split('/');
    const vehicleIndex = pathParts.indexOf('vehicles');
    if (vehicleIndex !== -1 && pathParts[vehicleIndex + 1]) {
        return pathParts[vehicleIndex + 1];
    }
    return null;
}

// ç›‘å¬å›è½¦é”®å‘é€æ¶ˆæ¯
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.activeElement.id === 'chat-input') {
        sendChatMessage();
    }
});

// é¡µé¢åŠ è½½æ—¶ï¼š1) åŠ è½½è½¦è¾†è¯¦æƒ… 2) è®°å½•æµè§ˆå†å²
document.addEventListener('DOMContentLoaded', async function() {
    await loadVehicleDetail();
    // å»¶è¿Ÿ100æ¯«ç§’åè®°å½•æµè§ˆå†å²ï¼Œç¡®ä¿é¡µé¢å·²åŠ è½½
    setTimeout(() => {
        recordBrowsingHistory();
    }, 100);
});
</script>
{% endblock %}