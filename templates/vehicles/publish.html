{% extends "base.html" %}
{% load static %}

{% block title %}发布车辆 - 二手车集市管理系统{% endblock %}

{% block extra_css %}
<style>
.publish-form {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 30px;
}

.form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.form-section:last-child {
    border-bottom: none;
}

.section-title {
    font-size: 18px;
    font-weight: bold;
    color: #333;
    margin-bottom: 20px;
    padding-left: 10px;
    border-left: 4px solid #ff6b35;
}

.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
}

.form-group.half {
    flex: 0.5;
}

.form-label {
    display: block;
    font-weight: 500;
    margin-bottom: 8px;
    color: #555;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-control:focus {
    outline: none;
    border-color: #ff6b35;
    box-shadow: 0 0 0 2px rgba(255,107,53,0.1);
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

.image-upload-area {
    border: 2px dashed #ddd;
    border-radius: 6px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.3s;
}

.image-upload-area:hover {
    border-color: #ff6b35;
}

.image-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.image-item {
    position: relative;
    border-radius: 6px;
    overflow: hidden;
    aspect-ratio: 4/3;
}

.image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-item .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255,0,0,0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 12px;
}

.highlight-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.highlight-tag {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    background: #f0f0f0;
    border-radius: 20px;
    font-size: 14px;
}

.btn-group {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.btn {
    padding: 12px 30px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: #ff6b35;
    color: white;
}

.btn-primary:hover {
    background: #e55a2b;
}

.btn-secondary {
    background: #f5f5f5;
    color: #666;
}

.btn-secondary:hover {
    background: #e8e8e8;
}

.price-input-group {
    position: relative;
}

.price-input-group .currency {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
}

.price-input-group .form-control {
    padding-left: 30px;
}

.loading {
    display: none;
    text-align: center;
    margin: 20px 0;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #ff6b35;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.success-message {
    background: #d4edda;
    color: #155724;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">发布车辆</h2>

            <div class="publish-form">
                <form id="vehiclePublishForm">
                    <!-- 基本信息 -->
                    <div class="form-section">
                        <h3 class="section-title">基本信息</h3>

                        <div class="form-row">
                            <div class="form-group half">
                                <label class="form-label">车辆品牌 <span class="text-danger">*</span></label>
                                <select class="form-control" id="brand" name="brand" required>
                                    <option value="">请选择品牌</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">车辆类型</label>
                                <select class="form-control" id="car_type" name="car_type">
                                    <option value="">请选择类型</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">车型名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="model_name" name="model_name"
                                       placeholder="例如：奥迪A4L 2023款 45 TFSI quattro" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label class="form-label">年份 <span class="text-danger">*</span></label>
                                <select class="form-control" id="year" name="year" required>
                                    <option value="">请选择年份</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">车身颜色 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="color" name="color"
                                       placeholder="例如：白色、黑色、银色" required>
                            </div>
                        </div>
                    </div>

                    <!-- 车辆信息 -->
                    <div class="form-section">
                        <h3 class="section-title">车辆信息</h3>

                        <div class="form-row">
                            <div class="form-group half">
                                <label class="form-label">变速箱</label>
                                <select class="form-control" id="transmission" name="transmission">
                                    <option value="manual">手动</option>
                                    <option value="auto" selected>自动</option>
                                    <option value="cvt">CVT</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">燃料类型</label>
                                <select class="form-control" id="fuel_type" name="fuel_type">
                                    <option value="gasoline" selected>汽油</option>
                                    <option value="diesel">柴油</option>
                                    <option value="electric">电动</option>
                                    <option value="hybrid">混合动力</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label class="form-label">排放标准</label>
                                <select class="form-control" id="emission_standard" name="emission_standard">
                                    <option value="euro6" selected>国VI</option>
                                    <option value="euro5">国V</option>
                                    <option value="euro4">国IV</option>
                                    <option value="euro3">国III</option>
                                    <option value="euro2">国II</option>
                                    <option value="euro1">国I</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">行驶里程(公里) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="mileage" name="mileage"
                                       placeholder="请输入行驶里程公里数" min="0" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label class="form-label">上牌时间 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="plate_date" name="plate_date" required>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">首次上牌时间</label>
                                <input type="date" class="form-control" id="first_owner_date" name="first_owner_date">
                            </div>
                        </div>
                    </div>

                    <!-- 价格信息 -->
                    <div class="form-section">
                        <h3 class="section-title">价格信息</h3>

                        <div class="form-row">
                            <div class="form-group half">
                                <label class="form-label">售价(元) <span class="text-danger">*</span></label>
                                <div class="price-input-group">
                                    <span class="currency">¥</span>
                                    <input type="number" class="form-control" id="price" name="price"
                                           placeholder="请输入售价金额" min="0" step="100" required>
                                </div>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">VIN码<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="vin" name="vin"
                                       placeholder="17位VIN码" maxlength="17" pattern="[A-HJ-NPR-Z0-9]{17}" required>
                            </div>
                        </div>
                    </div>

                    <!-- 描述信息 -->
                    <div class="form-section">
                        <h3 class="section-title">描述信息</h3>

                        <div class="form-group">
                            <label class="form-label">车辆描述 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="description" name="description"
                                      placeholder="请详细描述车况、保养信息、有无事故等信息..." rows="6" required></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">车辆亮点</label>
                            <div class="highlight-tags">
                                <label><input type="checkbox" name="highlights" value="无事故"> 无事故</label>
                                <label><input type="checkbox" name="highlights" value="全程4S店保养"> 全程4S店保养</label>
                                <label><input type="checkbox" name="highlights" value="一手车"> 一手车</label>
                                <label><input type="checkbox" name="highlights" value="精品车况"> 精品车况</label>
                                <label><input type="checkbox" name="highlights" value="准新车"> 准新车</label>
                                <label><input type="checkbox" name="highlights" value="定期保养"> 定期保养</label>
                                <label><input type="checkbox" name="highlights" value="全程质保"> 全程质保</label>
                                <label><input type="checkbox" name="highlights" value="原版原漆"> 原版原漆</label>
                            </div>
                        </div>
                    </div>

                    <!-- 车辆照片 -->
                    <div class="form-section">
                        <h3 class="section-title">车辆照片</h3>

                        <div class="image-upload-area" id="imageUploadArea">
                            <div>
                                <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ccc;"></i>
                                <p style="margin: 10px 0; color: #666;">点击或拖拽上传车辆照片</p>
                                <p style="color: #999; font-size: 14px;">支持JPG、PNG格式，建议上传10-15张车辆照片</p>
                            </div>
                            <input type="file" id="imageInput" multiple accept="image/*" style="display: none;">
                        </div>

                        <div class="image-preview" id="imagePreview"></div>
                    </div>

                    <!-- 提交按钮 -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="window.history.back()">返回</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">提交审核</button>
                    </div>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">正在提交，请稍候...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 检查用户登录状态和token有效性
function checkAuthentication() {
    const token = localStorage.getItem('accessToken');
    const userInfo = localStorage.getItem('userInfo');

    console.log('认证检查:', {
        hasToken: !!token,
        hasUserInfo: !!userInfo,
        tokenLength: token ? token.length : 0
    });

    if (!token) {
        showMessage('error', '请先登录后再发布车辆');
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
        return false;
    }

    return true;
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 首先检查认证状态
    if (!checkAuthentication()) {
        return;
    }

    initializeBrands();
    initializeYears();
    setupImageUpload();
    setupFormSubmit();
});

// 初始化品牌下拉选择
async function initializeBrands() {
    try {
        // 尝试多个可能的API端点
        const apiEndpoints = [
            '/api/vehicles/brands/',
            `${window.API_BASE_URL || '/api'}/vehicles/brands/`
        ];

        let data = null;
        let workingEndpoint = null;

        for (const endpoint of apiEndpoints) {
            try {
                console.log(`尝试获取品牌数据: ${endpoint}`);
                const response = await fetch(endpoint);

                if (response.ok) {
                    data = await response.json();
                    workingEndpoint = endpoint;
                    console.log(`成功获取品牌数据:`, data);
                    break;
                } else {
                    console.warn(`端点 ${endpoint} 返回状态: ${response.status}`);
                }
            } catch (endpointError) {
                console.warn(`端点 ${endpoint} 请求失败:`, endpointError);
                continue;
            }
        }

        if (!data) {
            throw new Error('所有API端点都无法访问');
        }

        const brandSelect = document.getElementById('brand');

        // 处理可能的不同API返回格式
        const brands = Array.isArray(data) ? data : (data.results || []);

        if (brands.length === 0) {
            console.warn('品牌列表为空');
            const option = document.createElement('option');
            option.value = "";
            option.textContent = '暂无品牌数据';
            brandSelect.appendChild(option);
            return;
        }

        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand.id;
            option.textContent = brand.name;
            brandSelect.appendChild(option);
        });

        console.log(`成功加载 ${brands.length} 个品牌`);

        // 品牌选择变化时加载车型
        brandSelect.addEventListener('change', loadCarTypes);

    } catch (error) {
        console.error('加载品牌失败:', error);
        const brandSelect = document.getElementById('brand');
        brandSelect.innerHTML = '<option value="">加载失败</option>';
        alert('加载品牌失败，请刷新页面重试');
    }
}

// 加载车型
async function loadCarTypes() {
    const brandId = document.getElementById('brand').value;
    const carTypeSelect = document.getElementById('car_type');

    // 清空当前选项
    carTypeSelect.innerHTML = '<option value="">请选择类型</option>';

    if (!brandId) return;

    try {
        const response = await fetch('/api/vehicles/types/');
        const data = await response.json();

        // 处理可能的不同API返回格式
        const types = Array.isArray(data) ? data : (data.results || []);

        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            carTypeSelect.appendChild(option);
        });
    } catch (error) {
        console.error('加载车型失败:', error);
    }
}

// 初始化年份选择
function initializeYears() {
    const yearSelect = document.getElementById('year');
    const currentYear = new Date().getFullYear();

    for (let year = currentYear; year >= 2000; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        if (year === currentYear - 1) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

// 设置图片上传
function setupImageUpload() {
    const uploadArea = document.getElementById('imageUploadArea');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');

    uploadArea.addEventListener('click', () => imageInput.click());

    imageInput.addEventListener('change', handleImageSelect);

    // 拖拽上传
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ff6b35';
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = '#ddd';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ddd';
        handleImageSelect({ target: { files: e.dataTransfer.files } });
    });
}

// 处理图片选择
function handleImageSelect(event) {
    const files = Array.from(event.target.files);
    const imagePreview = document.getElementById('imagePreview');

    files.forEach((file, index) => {
        if (!file.type.startsWith('image/')) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.innerHTML = `
                <img src="${e.target.result}" alt="预览图片">
                <button type="button" class="delete-btn" onclick="removeImage(this)">×</button>
            `;
            imagePreview.appendChild(imageItem);
        };
        reader.readAsDataURL(file);
    });
}

// 删除图片
function removeImage(btn) {
    btn.parentElement.remove();
}

// 设置表单提交
function setupFormSubmit() {
    const form = document.getElementById('vehiclePublishForm');
    const loading = document.getElementById('loading');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }

        loading.style.display = 'block';
        submitBtn.disabled = true;

        try {
            // 使用FormData来处理表单数据和文件
            const formDataToSubmit = new FormData(form);
            const token = localStorage.getItem('accessToken');

            // 详细的token验证
            console.log('Token检查:', {
                hasToken: !!token,
                tokenLength: token ? token.length : 0,
                tokenStart: token ? token.substring(0, 20) + '...' : 'none'
            });

            if (!token) {
                showMessage('error', '请先登录，未找到访问令牌');
                loading.style.display = 'none';
                submitBtn.disabled = false;
                return;
            }

            if (token.length < 10) {
                showMessage('error', '访问令牌无效，请重新登录');
                localStorage.removeItem('accessToken'); // 清除无效token
                loading.style.display = 'none';
                submitBtn.disabled = false;
                return;
            }

            // 从预览区域获取所有上传的图片
            const imageItems = document.querySelectorAll('.image-item img');
            if (imageItems.length === 0) {
                showMessage('error', '请至少上传一张车辆照片');
                loading.style.display = 'none';
                submitBtn.disabled = false;
                return;
            }

            // 图片预览是通过FileReader显示的，我们需要从imageInput获取实际文件
            const imageInput = document.getElementById('imageInput');
            const files = imageInput.files;

            // 清空FormData中已有数据，重新构建
            const finalFormData = new FormData();

            // 添加表单字段
            finalFormData.append('vin', form.elements['vin'].value);
            finalFormData.append('brand', form.elements['brand'].value);
            finalFormData.append('car_type', form.elements['car_type'].value || '');
            finalFormData.append('model_name', form.elements['model_name'].value);
            finalFormData.append('year', form.elements['year'].value);
            finalFormData.append('color', form.elements['color'].value);
            finalFormData.append('transmission', form.elements['transmission'].value);
            finalFormData.append('fuel_type', form.elements['fuel_type'].value);
            finalFormData.append('emission_standard', form.elements['emission_standard'].value);
            finalFormData.append('mileage', form.elements['mileage'].value);
            finalFormData.append('plate_date', form.elements['plate_date'].value);
            finalFormData.append('first_owner_date', form.elements['first_owner_date'].value || '');
            finalFormData.append('description', form.elements['description'].value);
            finalFormData.append('price', form.elements['price'].value);

            // 添加亮点(多选)
            const highlightCheckboxes = form.querySelectorAll('input[name="highlights"]:checked');
            const highlights = Array.from(highlightCheckboxes).map(cb => cb.value);
            finalFormData.append('highlights', JSON.stringify(highlights));

            // 添加图片文件
            for (let i = 0; i < files.length; i++) {
                finalFormData.append('images', files[i]);
            }

            // 尝试多个可能的API端点
            const apiEndpoints = [
                '/api/vehicles/',
                '/api/vehicles/my_vehicles/',
                '/api/seller/vehicles/'
            ];

            let response = null;
            let result = null;
            let workingEndpoint = null;

            for (const endpoint of apiEndpoints) {
                try {
                    console.log(`尝试API端点: ${endpoint}`);

                    // 创建新的FormData对象（因为FormData只能使用一次）
                    const endpointFormData = new FormData();
                    for (let [key, value] of finalFormData.entries()) {
                        endpointFormData.append(key, value);
                    }

                    response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: endpointFormData
                    });

                    console.log(`端点 ${endpoint} 响应状态:`, response.status);

                    if (response.ok || response.status === 400 || response.status === 401) {
                        workingEndpoint = endpoint;
                        result = await response.json();
                        break;
                    }
                } catch (endpointError) {
                    console.warn(`端点 ${endpoint} 请求失败:`, endpointError);
                    continue;
                }
            }

            if (!response) {
                throw new Error('所有API端点都无法访问');
            }

            console.log('最终API响应:', {
                status: response.status,
                endpoint: workingEndpoint,
                result: result
            });

            if (response.ok) {
                showMessage('success', '车辆信息提交成功！即将跳转到卖家中心');
                setTimeout(() => {
                    window.location.href = '/seller/vehicles/';
                }, 2000);
            } else {
                console.error('API返回错误:', result);

                let errorMessage = '提交失败';

                if (response.status === 401) {
                    errorMessage = '身份验证失败，请重新登录';
                    localStorage.removeItem('accessToken'); // 清除无效token
                } else if (response.status === 403) {
                    errorMessage = '权限不足，无法发布车辆';
                } else if (response.status === 400) {
                    // 显示详细的验证错误
                    if (typeof result === 'object') {
                        const errors = Object.entries(result).map(([field, messages]) => {
                            const fieldName = document.querySelector(`[name="${field}"]`)?.previousElementSibling?.textContent || field;
                            const messageList = Array.isArray(messages) ? messages.join(', ') : messages;
                            return `${fieldName}: ${messageList}`;
                        });
                        errorMessage = errors.join('; ');
                    } else {
                        errorMessage = result.detail || result.error || '输入数据有误';
                    }
                } else {
                    errorMessage = result.detail || result.error || `服务器错误 (${response.status})`;
                }

                showMessage('error', errorMessage);
            }
        } catch (error) {
            console.error('提交失败:', error);
            showMessage('error', '网络错误，请重试');
        } finally {
            loading.style.display = 'none';
            submitBtn.disabled = false;
        }
    });
}

// 表单验证
function validateForm() {
    const requiredFields = ['brand', 'model_name', 'year', 'color', 'mileage', 'plate_date', 'price', 'vin', 'description'];

    for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.focus();
            showMessage('error', '请填写所有必填字段');
            return false;
        }
    }

    const vin = document.getElementById('vin').value;
    if (vin.length !== 17 || !/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
        document.getElementById('vin').focus();
        showMessage('error', '请输入正确的17位VIN码');
        return false;
    }

    return true;
}

// 获取表单数据
function getFormData() {
    const formData = new FormData(document.getElementById('vehiclePublishForm'));
    const data = {};

    // 转换表单数据
    for (let [key, value] of formData.entries()) {
        if (key === 'highlights') {
            if (!data.highlights) data.highlights = [];
            data.highlights.push(value);
        } else {
            data[key] = value;
        }
    }

    // 转换数字字段
    ['year', 'mileage', 'price'].forEach(field => {
        if (data[field]) {
            data[field] = parseInt(data[field]);
        }
    });

    // 转换日期字段
    ['plate_date', 'first_owner_date'].forEach(field => {
        if (data[field]) {
            data[field] = data[field];
        }
    });

    return data;
}

// 显示消息
function showMessage(type, message) {
    const existingMessage = document.querySelector('.success-message, .error-message');
    if (existingMessage) {
        existingMessage.remove();
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `${type}-message`;
    messageDiv.textContent = message;

    const form = document.getElementById('vehiclePublishForm');
    form.insertBefore(messageDiv, form.firstChild);

    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}
</script>
{% endblock %}