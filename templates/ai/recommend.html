{% extends "base.html" %}

{% block title %}AIæ™ºèƒ½æ¨è - äºŒæ‰‹è½¦é›†å¸‚{% endblock %}

{% block content %}
<div class="container">
    <div class="ai-recommend-container" style="max-width: 1000px; margin: 0 auto; padding: 20px 0;">
        <div class="page-header" style="text-align: center; margin-bottom: 40px;">
            <h1 style="color: #333; margin-bottom: 15px;">ğŸ¤– AIæ™ºèƒ½è½¦è¾†æ¨è</h1>
            <p style="color: #666; font-size: 16px;">å‘Šè¯‰æˆ‘ä»¬æ‚¨çš„éœ€æ±‚ï¼ŒAIä¸ºæ‚¨æ¨èæœ€åˆé€‚çš„è½¦è¾†</p>
        </div>

        <div class="recommend-form-container" style="background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
            <h3 style="margin-top: 0; margin-bottom: 25px; color: #333;">è¯·æè¿°æ‚¨çš„éœ€æ±‚</h3>

            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">å“ç‰Œåå¥½</label>
                    <select id="brand-preference" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ä¸é™å“ç‰Œ</option>
                        <option value="å›½äº§">å›½äº§</option>
                        <option value="åˆèµ„">åˆèµ„</option>
                        <option value="è¿›å£">è¿›å£</option>
                        <option value="å¤§ä¼—">å¤§ä¼—</option>
                        <option value="ä¸°ç”°">ä¸°ç”°</option>
                        <option value="æœ¬ç”°">æœ¬ç”°</option>
                        <option value="æ—¥äº§">æ—¥äº§</option>
                        <option value="ç°ä»£">ç°ä»£</option>
                        <option value="å¥¥è¿ª">å¥¥è¿ª</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">è½¦å‹åå¥½</label>
                    <select id="type-preference" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ä¸é™è½¦å‹</option>
                        <option value="è½¿è½¦">è½¿è½¦</option>
                        <option value="SUV">SUV</option>
                        <option value="MPV">MPV</option>
                        <option value="è·‘è½¦">è·‘è½¦</option>
                        <option value="çš®å¡">çš®å¡</option>
                    </select>
                </div>
            </div>

            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">é¢„ç®—èŒƒå›´</label>
                    <select id="budget-range" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ä¸é™é¢„ç®—</option>
                        <option value="0-50000">5ä¸‡ä»¥å†…</option>
                        <option value="50000-100000">5-10ä¸‡</option>
                        <option value="100000-200000">10-20ä¸‡</option>
                        <option value="200000-300000">20-30ä¸‡</option>
                        <option value="300000-500000">30-50ä¸‡</option>
                        <option value="500000+">50ä¸‡ä»¥ä¸Š</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">å¹´ä»½èŒƒå›´</label>
                    <select id="year-range" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ä¸é™å¹´ä»½</option>
                        <option value="2020-2025">2020å¹´å</option>
                        <option value="2018-2020">2018-2020å¹´</option>
                        <option value="2015-2018">2015-2018å¹´</option>
                        <option value="2010-2015">2010-2015å¹´</option>
                        <option value="2010-">2010å¹´ä»¥å‰</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">è¯¦ç»†éœ€æ±‚æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="detail-requirements" rows="4" placeholder="ä¾‹å¦‚ï¼šä¸»è¦ç”¨é€”æ˜¯ä¸Šä¸‹ç­å‡ºè¡Œï¼Œå¶å°”å¸¦å®¶äººå‡ºè¡Œï¼Œå¸Œæœ›ç©ºé—´å¤§ä¸€ç‚¹ï¼Œä¸è¦å¤ªé«˜é…ï¼Œæœ€å¥½çœæ²¹ä¸€ç‚¹..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
            </div>

            <button onclick="getAIRecommendations()" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 4px; color: white; font-weight: 600; cursor: pointer;">
                ğŸ¤– è·å–AIæ¨è
            </button>
        </div>

        <div id="recommendation-results" style="display: none;">
            <div class="ai-analysis" style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                <h3 style="margin-top: 0; margin-bottom: 15px; color: #1976d2;">ğŸ¤– AIåˆ†æç»“æœ</h3>
                <div id="ai-analysis-content" style="line-height: 1.6;"></div>
            </div>

            <div class="recommended-vehicles">
                <h3 style="margin-bottom: 20px; color: #333;">ğŸš— æ¨èè½¦è¾†åˆ—è¡¨</h3>
                <div id="vehicles-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <!-- æ¨èè½¦è¾†å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <div id="loading-indicator" style="display: none; text-align: center; padding: 40px;">
            <div style="display: inline-block; text-align: center;">
                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                <p style="color: #666; font-size: 16px;">AIæ­£åœ¨åˆ†ææ‚¨çš„éœ€æ±‚ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .vehicle-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .vehicle-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .vehicle-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f8f9fa;
    }

    .vehicle-info {
        padding: 15px;
    }

    .vehicle-title {
        font-size: 16px;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
    }

    .vehicle-specs {
        color: #666;
        font-size: 14px;
        margin-bottom: 10px;
    }

    .vehicle-price {
        font-size: 18px;
        font-weight: bold;
        color: #e74c3c;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr !important;
        }

        #vehicles-grid {
            grid-template-columns: 1fr !important;
        }
    }
</style>

<script>
async function getAIRecommendations() {
    // è·å–ç”¨æˆ·è¾“å…¥
    const preferences = {
        brand: document.getElementById('brand-preference').value,
        car_type: document.getElementById('type-preference').value,
        budget_range: document.getElementById('budget-range').value,
        year_range: document.getElementById('year-range').value,
        detailed_requirements: document.getElementById('detail-requirements').value.trim()
    };

    // éªŒè¯è¾“å…¥
    if (!preferences.brand && !preferences.car_type && !preferences.budget_range &&
        !preferences.year_range && !preferences.detailed_requirements) {
        API.Utils.showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­›é€‰æ¡ä»¶æˆ–æè¿°æ‚¨çš„éœ€æ±‚', 'error');
        return;
    }

    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('recommendation-results').style.display = 'none';

    try {
        // å¤„ç†é¢„ç®—å’Œå¹´ä»½èŒƒå›´
        if (preferences.budget_range) {
            if (preferences.budget_range === '500000+') {
                preferences.price_max = 1000000;
            } else {
                const [min, max] = preferences.budget_range.split('-').map(Number);
                preferences.price_min = min;
                preferences.price_max = max;
            }
        }

        if (preferences.year_range) {
            if (preferences.year_range === '2010-') {
                preferences.year_max = 2009;
            } else {
                const [min, max] = preferences.year_range.split('-').map(Number);
                preferences.year_min = min;
                preferences.year_max = max;
            }
        }

        // è°ƒç”¨AIæ¨èAPI
        const result = await API.AIManager.getVehicleRecommendations(preferences);

        if (result.success) {
            displayRecommendations(result, preferences);
        } else {
            throw new Error(result.error || 'è·å–æ¨èå¤±è´¥');
        }

    } catch (error) {
        console.error('Get recommendations error:', error);
        API.Utils.showAlert('è·å–æ¨èå¤±è´¥: ' + error.message, 'error');
    } finally {
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

function displayRecommendations(result, preferences) {
    const resultsDiv = document.getElementById('recommendation-results');
    const analysisDiv = document.getElementById('ai-analysis-content');
    const vehiclesGrid = document.getElementById('vehicles-grid');

    // æ˜¾ç¤ºAIåˆ†æ
    analysisDiv.innerHTML = `
        <div style="background: white; padding: 15px; border-radius: 4px; margin-top: 10px;">
            <p><strong>æ‚¨çš„éœ€æ±‚åå¥½ï¼š</strong></p>
            <ul style="margin: 10px 0; padding-left: 20px;">
                ${preferences.brand ? `<li>å“ç‰Œï¼š${preferences.brand}</li>` : ''}
                ${preferences.car_type ? `<li>è½¦å‹ï¼š${preferences.car_type}</li>` : ''}
                ${preferences.budget_range ? `<li>é¢„ç®—ï¼š${preferences.budget_range}</li>` : ''}
                ${preferences.year_range ? `<li>å¹´ä»½ï¼š${preferences.year_range}</li>` : ''}
                ${preferences.detailed_requirements ? `<li>è¯¦ç»†éœ€æ±‚ï¼š${preferences.detailed_requirements}</li>` : ''}
            </ul>
            <div style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 4px; line-height: 1.8;">
                <strong>AIæ¨èåˆ†æï¼š</strong><br>
                <div style="white-space: pre-wrap; margin-top: 10px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;">
${(result.ai_recommendations.analysis || result.ai_recommendations.recommendations || 'AIå·²æ ¹æ®æ‚¨çš„éœ€æ±‚è¿›è¡Œåˆ†æ').replace(/\\n/g, '<br>')}
                </div>
            </div>
        </div>
    `;

    // æ˜¾ç¤ºæ¨èè½¦è¾†
    const vehicles = result.matching_vehicles || [];

    if (vehicles.length > 0) {
        vehiclesGrid.innerHTML = vehicles.map(vehicle => `
            <div class="vehicle-card" onclick="viewVehicleDetail(${vehicle.id})">
                <img src="${vehicle.main_photo || '/static/images/placeholder.png'}"
                     alt="${vehicle.brand} ${vehicle.model}"
                     class="vehicle-image"
                     onerror="this.src='/static/images/placeholder.png'">
                <div class="vehicle-info">
                    <div class="vehicle-title">${vehicle.brand} ${vehicle.model} ${vehicle.year}æ¬¾</div>
                    <div class="vehicle-specs">
                        ${vehicle.year}å¹´ | ${vehicle.mileage ? vehicle.mileage.toLocaleString() : 'æœªçŸ¥'}å…¬é‡Œ | ${vehicle.color || 'æœªçŸ¥é¢œè‰²'}
                    </div>
                    <div class="vehicle-price">Â¥${vehicle.price ? vehicle.price.toLocaleString('zh-CN') : 'é¢è®®'}</div>
                </div>
            </div>
        `).join('');
    } else {
        vehiclesGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                <p style="color: #666; font-size: 16px; margin-bottom: 15px;">ğŸ¤· æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°å®Œå…¨ç¬¦åˆæ‚¨éœ€æ±‚çš„è½¦è¾†</p>
                <p style="color: #999;">å»ºè®®è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–è”ç³»æˆ‘ä»¬ä¸ºæ‚¨å¯»æ‰¾</p>
            </div>
        `;
    }

    resultsDiv.style.display = 'block';

    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function viewVehicleDetail(vehicleId) {
    window.location.href = `/vehicles/detail/?id=${vehicleId}`;
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æ·»åŠ ä¸€äº›å¿«æ·é€‰æ‹©æŒ‰é’®
    const detailTextarea = document.getElementById('detail-requirements');

    // å¿«æ·éœ€æ±‚é€‰é¡¹
    const quickButtons = [
        'å®¶ç”¨ä»£æ­¥è½¦ï¼Œçœæ²¹ç©ºé—´å¤§',
        'å•†åŠ¡æ¥å¾…ç”¨ï¼Œè¦å¤§æ°”ç¨³é‡',
        'è¿åŠ¨æ€§èƒ½å¥½ï¼ŒåŠ¨åŠ›è¦å¼º',
        'è¶Šé‡èƒ½åŠ›å¼ºï¼Œåº•ç›˜è¦é«˜',
    ];

    // åˆ›å»ºå¿«æ·é€‰æ‹©æŒ‰é’®
    const buttonsContainer = document.createElement('div');
    buttonsContainer.style.cssText = 'margin-top: 10px; margin-bottom: 15px;';
    buttonsContainer.innerHTML = '<p style="margin-bottom: 8px; color: #666; font-size: 14px;">å¿«æ·é€‰æ‹©ï¼š</p>';

    const buttonsRow = document.createElement('div');
    buttonsRow.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';

    quickButtons.forEach(text => {
        const button = document.createElement('button');
        button.textContent = text;
        button.style.cssText = 'padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 12px; color: #666; transition: all 0.2s;';
        button.onmouseover = () => {
            button.style.background = '#e9ecef';
            button.style.color = '#333';
        };
        button.onmouseout = () => {
            button.style.background = '#f8f9fa';
            button.style.color = '#666';
        };
        button.onclick = () => {
            detailTextarea.value = (detailTextarea.value + ' ' + text).trim();
        };
        buttonsRow.appendChild(button);
    });

    buttonsContainer.appendChild(buttonsRow);
    detailTextarea.parentNode.insertBefore(buttonsContainer, detailTextarea.nextSibling);
});
</script>
{% endblock %}