{% extends "base.html" %}
{% load static %}

{% block title %}è´¦æˆ·è®¾ç½® - äºŒæ‰‹è½¦é›†å¸‚ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    .settings-container {
        max-width: 900px;
        margin: 30px auto;
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 30px;
    }

    .settings-sidebar {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        height: fit-content;
        position: sticky;
        top: 100px;
    }

    .settings-sidebar .menu-item {
        padding: 12px 16px;
        margin-bottom: 8px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        color: #333;
        transition: all 0.3s;
        border-left: 3px solid transparent;
    }

    .settings-sidebar .menu-item:hover,
    .settings-sidebar .menu-item.active {
        background: #f0f8ff;
        color: #007BFF;
        border-left-color: #007BFF;
    }

    .settings-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 30px;
    }

    .settings-section {
        display: none;
    }

    .settings-section.active {
        display: block;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #007BFF;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .btn-group {
        display: flex;
        gap: 12px;
        margin-top: 30px;
    }

    .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #007BFF;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #f0f0f0;
        color: #333;
    }

    .btn-secondary:hover {
        background: #e0e0e0;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .avatar-section {
        display: flex;
        align-items: flex-end;
        gap: 20px;
        margin-bottom: 30px;
    }

    .avatar-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: #999;
        overflow: hidden;
    }

    .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-upload {
        flex: 1;
    }

    .message {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
    }

    .message.success {
        display: block;
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .message.error {
        display: block;
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .info-item {
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 500;
        color: #666;
        min-width: 150px;
    }

    .info-value {
        color: #333;
        flex: 1;
    }

    @media (max-width: 768px) {
        .settings-container {
            grid-template-columns: 1fr;
        }

        .settings-sidebar {
            position: static;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .settings-sidebar .menu-item {
            margin-bottom: 0;
            text-align: center;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .avatar-section {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- è®¾ç½®èœå• -->
    <div class="settings-sidebar">
        <div class="menu-item active" onclick="showSection('general')">åŸºæœ¬è®¾ç½®</div>
        <div class="menu-item" onclick="showSection('privacy')">éšç§è®¾ç½®</div>
        <div class="menu-item" onclick="showSection('notification')">é€šçŸ¥è®¾ç½®</div>
        <div class="menu-item" onclick="showSection('security')">å®‰å…¨è®¾ç½®</div>
    </div>

    <!-- è®¾ç½®å†…å®¹ -->
    <div class="settings-content">
        <!-- åŸºæœ¬è®¾ç½® -->
        <div class="settings-section active" id="general">
            <h2 class="section-title">åŸºæœ¬è®¾ç½®</h2>
            <div id="generalMessage" class="message"></div>

            <!-- å¤´åƒä¸Šä¼  -->
            <div class="avatar-section">
                <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
                <div class="avatar-upload">
                    <label class="form-label">æ›´æ¢å¤´åƒ</label>
                    <input type="file" id="avatarInput" accept="image/*" class="form-control">
                    <small style="color: #999; font-size: 12px; display: block; margin-top: 8px;">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæœ€å¤§5MB</small>
                </div>
            </div>

            <form id="generalForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">æ˜µç§°</label>
                        <input type="text" id="nickname" class="form-control" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ€§åˆ«</label>
                        <select id="gender" class="form-control">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="male">ç”·</option>
                            <option value="female">å¥³</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="birthDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ‰€åœ¨åœ°åŒº</label>
                        <input type="text" id="location" class="form-control" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚æœé˜³åŒº" maxlength="255">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ä¸ªäººç®€ä»‹</label>
                    <textarea id="bio" class="form-control" placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±..." maxlength="500"></textarea>
                    <small style="color: #999; font-size: 12px; display: block; margin-top: 8px;"><span id="bioCount">0</span>/500</small>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
                    <button type="reset" class="btn btn-secondary">é‡ç½®</button>
                </div>
            </form>
        </div>

        <!-- éšç§è®¾ç½® -->
        <div class="settings-section" id="privacy">
            <h2 class="section-title">éšç§è®¾ç½®</h2>
            <div id="privacyMessage" class="message"></div>

            <form id="privacyForm">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="showPhone" class="form-control" style="width: auto;">
                        <span>åœ¨ä¸ªäººèµ„æ–™ä¸­æ˜¾ç¤ºç”µè¯å·ç </span>
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="showEmail" class="form-control" style="width: auto;">
                        <span>åœ¨ä¸ªäººèµ„æ–™ä¸­æ˜¾ç¤ºé‚®ç®±åœ°å€</span>
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="showLocation" class="form-control" style="width: auto;">
                        <span>åœ¨ä¸ªäººèµ„æ–™ä¸­æ˜¾ç¤ºæ‰€åœ¨åœ°åŒº</span>
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="allowMessages" class="form-control" style="width: auto;">
                        <span>å…è®¸å…¶ä»–ç”¨æˆ·ç»™æˆ‘å‘é€æ¶ˆæ¯</span>
                    </label>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
                </div>
            </form>
        </div>

        <!-- é€šçŸ¥è®¾ç½® -->
        <div class="settings-section" id="notification">
            <h2 class="section-title">é€šçŸ¥è®¾ç½®</h2>
            <div id="notificationMessage" class="message"></div>

            <form id="notificationForm">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="emailNotifications" class="form-control" style="width: auto;">
                        <span>æ¥æ”¶é‚®ä»¶é€šçŸ¥</span>
                    </label>
                    <small style="color: #999; display: block; margin-top: 8px;">è®¢å•çŠ¶æ€ã€è¯„è®ºç­‰é‡è¦ä¿¡æ¯</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="smsNotifications" class="form-control" style="width: auto;">
                        <span>æ¥æ”¶çŸ­ä¿¡é€šçŸ¥</span>
                    </label>
                    <small style="color: #999; display: block; margin-top: 8px;">éªŒè¯æ¶ˆæ¯å’Œè®¢å•ç¡®è®¤</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="promotionNotifications" class="form-control" style="width: auto;">
                        <span>æ¥æ”¶ä¿ƒé”€å’Œä¼˜æƒ é€šçŸ¥</span>
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="systemNotifications" class="form-control" style="width: auto;">
                        <span>æ¥æ”¶ç³»ç»Ÿé€šçŸ¥</span>
                    </label>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
                </div>
            </form>
        </div>

        <!-- å®‰å…¨è®¾ç½® -->
        <div class="settings-section" id="security">
            <h2 class="section-title">å®‰å…¨è®¾ç½®</h2>
            <div id="securityMessage" class="message"></div>

            <!-- è´¦æˆ·ä¿¡æ¯ -->
            <div style="margin-bottom: 30px;">
                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 15px;">è´¦æˆ·ä¿¡æ¯</h3>
                <div class="info-item">
                    <span class="info-label">ç”¨æˆ·å</span>
                    <span class="info-value" id="username">åŠ è½½ä¸­...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é‚®ç®±</span>
                    <span class="info-value" id="email">åŠ è½½ä¸­...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ‰‹æœºå·</span>
                    <span class="info-value" id="phone">åŠ è½½ä¸­...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">è´¦æˆ·çŠ¶æ€</span>
                    <span class="info-value" id="accountStatus">åŠ è½½ä¸­...</span>
                </div>
            </div>

            <!-- ä¿®æ”¹å¯†ç  -->
            <form id="passwordForm" style="max-width: 400px;">
                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 15px;">ä¿®æ”¹å¯†ç </h3>
                <div class="form-group">
                    <label class="form-label">å½“å‰å¯†ç </label>
                    <input type="password" id="currentPassword" class="form-control" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
                </div>

                <div class="form-group">
                    <label class="form-label">æ–°å¯†ç </label>
                    <input type="password" id="newPassword" class="form-control" placeholder="è¯·è¾“å…¥æ–°å¯†ç " minlength="8">
                    <small style="color: #999; display: block; margin-top: 8px;">å¯†ç é•¿åº¦è‡³å°‘8ä½ï¼Œéœ€è¦åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—</small>
                </div>

                <div class="form-group">
                    <label class="form-label">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                </div>
            </form>

            <!-- åˆ é™¤è´¦æˆ· -->
            <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #dc3545;">å±é™©æ“ä½œ</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    åˆ é™¤è´¦æˆ·å°†æ°¸ä¹…åˆ é™¤æ‚¨çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
                </p>
                <button type="button" class="btn btn-danger" onclick="deleteAccount()">åˆ é™¤è´¦æˆ·</button>
            </div>
        </div>
    </div>
</div>

<script>
// æ˜¾ç¤ºæŒ‡å®šçš„è®¾ç½®éƒ¨åˆ†
function showSection(sectionId) {
    // éšè—æ‰€æœ‰éƒ¨åˆ†
    document.querySelectorAll('.settings-section').forEach(section => {
        section.classList.remove('active');
    });

    // ç§»é™¤èœå•é¡¹çš„ active ç±»
    document.querySelectorAll('.settings-sidebar .menu-item').forEach(item => {
        item.classList.remove('active');
    });

    // æ˜¾ç¤ºé€‰ä¸­çš„éƒ¨åˆ†å’Œèœå•é¡¹
    document.getElementById(sectionId).classList.add('active');
    event.target.classList.add('active');

    // å¦‚æœæ˜¯å®‰å…¨è®¾ç½®ï¼ŒåŠ è½½è´¦æˆ·ä¿¡æ¯
    if (sectionId === 'security') {
        loadAccountInfo();
    }
}

// åŠ è½½è´¦æˆ·ä¿¡æ¯
async function loadAccountInfo() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
        const response = await fetch('/api/users/profile/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) throw new Error('è·å–ä¿¡æ¯å¤±è´¥');

        const data = await response.json();
        document.getElementById('username').textContent = data.username || 'æœªè®¾ç½®';
        document.getElementById('email').textContent = data.email || 'æœªè®¾ç½®';
        document.getElementById('phone').textContent = data.phone || 'æœªè®¾ç½®';
        document.getElementById('accountStatus').textContent = data.account_status === 'normal' ? 'æ­£å¸¸' : 'å¼‚å¸¸';
    } catch (error) {
        console.error('åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥:', error);
        showMessage('security', 'åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥', 'error');
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadGeneralSettings();
    loadPrivacySettings();
    loadNotificationSettings();
    loadAccountInfo();

    // åŸºæœ¬è®¾ç½®è¡¨å•æäº¤
    document.getElementById('generalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveGeneralSettings();
    });

    // éšç§è®¾ç½®è¡¨å•æäº¤
    document.getElementById('privacyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await savePrivacySettings();
    });

    // é€šçŸ¥è®¾ç½®è¡¨å•æäº¤
    document.getElementById('notificationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveNotificationSettings();
    });

    // å¯†ç ä¿®æ”¹è¡¨å•æäº¤
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await changePassword();
    });

    // å¤´åƒä¸Šä¼ 
    document.getElementById('avatarInput').addEventListener('change', async (e) => {
        await uploadAvatar(e);
    });

    // ä¸ªäººç®€ä»‹å­—æ•°ç»Ÿè®¡
    document.getElementById('bio').addEventListener('input', function() {
        document.getElementById('bioCount').textContent = this.value.length;
    });
});

// åŠ è½½åŸºæœ¬è®¾ç½®
async function loadGeneralSettings() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
        const response = await fetch('/api/users/profile/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) throw new Error('è·å–ä¿¡æ¯å¤±è´¥');

        const data = await response.json();
        document.getElementById('nickname').value = data.nickname || '';
        document.getElementById('gender').value = data.gender || '';
        document.getElementById('birthDate').value = data.birth_date || '';
        document.getElementById('location').value = data.location || '';
        document.getElementById('bio').value = data.bio || '';
        document.getElementById('bioCount').textContent = (data.bio || '').length;

        // æ›´æ–°å¤´åƒé¢„è§ˆ
        if (data.avatar) {
            document.getElementById('avatarPreview').innerHTML = `<img src="${data.avatar}" alt="å¤´åƒ">`;
        } else {
            const username = data.username || '';
            document.getElementById('avatarPreview').textContent = username.charAt(0).toUpperCase() || 'ğŸ‘¤';
        }
    } catch (error) {
        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
    }
}

// ä¿å­˜åŸºæœ¬è®¾ç½®
async function saveGeneralSettings() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    const data = {
        nickname: document.getElementById('nickname').value,
        gender: document.getElementById('gender').value,
        birth_date: document.getElementById('birthDate').value,
        location: document.getElementById('location').value,
        bio: document.getElementById('bio').value
    };

    try {
        const response = await fetch('/api/users/settings/general/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error('ä¿å­˜å¤±è´¥');

        showMessage('general', 'è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        showMessage('general', 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// ä¸Šä¼ å¤´åƒ
async function uploadAvatar(event) {
    const file = event.target.files[0];
    if (!file) return;

    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
    if (file.size > 5 * 1024 * 1024) {
        showMessage('general', 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
        return;
    }

    const token = localStorage.getItem('accessToken');
    const formData = new FormData();
    formData.append('avatar', file);

    try {
        const response = await fetch('/api/users/settings/avatar/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (!response.ok) throw new Error('ä¸Šä¼ å¤±è´¥');

        const data = await response.json();
        document.getElementById('avatarPreview').innerHTML = `<img src="${data.avatar}" alt="å¤´åƒ">`;
        showMessage('general', 'å¤´åƒä¸Šä¼ æˆåŠŸ', 'success');
    } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        showMessage('general', 'å¤´åƒä¸Šä¼ å¤±è´¥', 'error');
    }
}

// åŠ è½½éšç§è®¾ç½®
async function loadPrivacySettings() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
        const response = await fetch('/api/users/settings/privacy/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

        const data = await response.json();
        document.getElementById('showPhone').checked = !!data.show_phone;
        document.getElementById('showEmail').checked = !!data.show_email;
        document.getElementById('showLocation').checked = !!data.show_location;
        document.getElementById('allowMessages').checked = !!data.allow_messages;
    } catch (error) {
        console.error('åŠ è½½éšç§è®¾ç½®å¤±è´¥:', error);
        showMessage('privacy', 'åŠ è½½éšç§è®¾ç½®å¤±è´¥', 'error');
    }
}

// ä¿å­˜éšç§è®¾ç½®
async function savePrivacySettings() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    const payload = {
        show_phone: document.getElementById('showPhone').checked,
        show_email: document.getElementById('showEmail').checked,
        show_location: document.getElementById('showLocation').checked,
        allow_messages: document.getElementById('allowMessages').checked
    };

    try {
        const response = await fetch('/api/users/settings/privacy/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('ä¿å­˜å¤±è´¥');

        showMessage('privacy', 'éšç§è®¾ç½®å·²ä¿å­˜', 'success');
    } catch (error) {
        console.error('ä¿å­˜éšç§è®¾ç½®å¤±è´¥:', error);
        showMessage('privacy', 'ä¿å­˜éšç§è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}


// åŠ è½½é€šçŸ¥è®¾ç½®
async function loadNotificationSettings() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
        const response = await fetch('/api/users/settings/notification/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

        const data = await response.json();
        document.getElementById('emailNotifications').checked = !!data.email_notifications;
        document.getElementById('smsNotifications').checked = !!data.sms_notifications;
        document.getElementById('promotionNotifications').checked = !!data.promotion_notifications;
        document.getElementById('systemNotifications').checked = !!data.system_notifications;
    } catch (error) {
        console.error('åŠ è½½é€šçŸ¥è®¾ç½®å¤±è´¥:', error);
        showMessage('notification', 'åŠ è½½é€šçŸ¥è®¾ç½®å¤±è´¥', 'error');
    }
}

// ä¿å­˜é€šçŸ¥è®¾ç½®
async function saveNotificationSettings() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    const payload = {
        email_notifications: document.getElementById('emailNotifications').checked,
        sms_notifications: document.getElementById('smsNotifications').checked,
        promotion_notifications: document.getElementById('promotionNotifications').checked,
        system_notifications: document.getElementById('systemNotifications').checked
    };

    try {
        const response = await fetch('/api/users/settings/notification/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('ä¿å­˜å¤±è´¥');

        showMessage('notification', 'é€šçŸ¥è®¾ç½®å·²ä¿å­˜', 'success');
    } catch (error) {
        console.error('ä¿å­˜é€šçŸ¥è®¾ç½®å¤±è´¥:', error);
        showMessage('notification', 'ä¿å­˜é€šçŸ¥è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}


// ä¿®æ”¹å¯†ç 
async function changePassword() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // ç¡®è®¤å¯†ç 
    if (!currentPassword || !newPassword || !confirmPassword) {
        showMessage('security', 'è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ', 'error');
        return;
    }

    if (newPassword !== confirmPassword) {
        showMessage('security', 'æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸ä¸€è‡´', 'error');
        return;
    }

    if (newPassword.length < 8) {
        showMessage('security', 'å¯†ç é•¿åº¦è‡³å°‘8ä½', 'error');
        return;
    }

    try {
        const response = await fetch('/api/users/change-password/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword,
                confirm_password: confirmPassword
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'ä¿®æ”¹å¤±è´¥');
        }

        showMessage('security', 'å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
        document.getElementById('passwordForm').reset();
    } catch (error) {
        console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
        showMessage('security', error.message || 'å¯†ç ä¿®æ”¹å¤±è´¥', 'error');
    }
}

// åˆ é™¤è´¦æˆ·
async function deleteAccount() {
    const confirmed = confirm('ç¡®å®šè¦åˆ é™¤è´¦æˆ·å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼');
    if (!confirmed) return;

    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
        const response = await fetch('/api/users/delete-account/', {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');

        // æ¸…é™¤tokenå¹¶è·³è½¬åˆ°é¦–é¡µ
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        alert('è´¦æˆ·å·²åˆ é™¤ï¼Œå³å°†è·³è½¬åˆ°é¦–é¡µ');
        window.location.href = '/';
    } catch (error) {
        console.error('åˆ é™¤è´¦æˆ·å¤±è´¥:', error);
        alert('åˆ é™¤è´¦æˆ·å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(sectionId, message, type) {
    const messageElement = document.getElementById(sectionId + 'Message');
    if (!messageElement) return;

    messageElement.textContent = message;
    messageElement.className = `message ${type}`;

    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        messageElement.className = 'message';
        messageElement.textContent = '';
    }, 3000);
}
</script>
{% endblock %}