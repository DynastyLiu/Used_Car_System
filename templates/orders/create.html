{% extends "base.html" %}
{% load static %}

{% block title %}åˆ›å»ºè®¢å• - äºŒæ‰‹è½¦é›†å¸‚ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
.order-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.breadcrumb {
    background: #f8f9fa;
    padding: 15px 0;
    margin-bottom: 30px;
    border-radius: 8px;
}

.breadcrumb a {
    color: #666;
    text-decoration: none;
}

.breadcrumb a:hover {
    color: #ff6b35;
}

.breadcrumb .separator {
    margin: 0 10px;
    color: #999;
}

.order-steps {
    display: flex;
    justify-content: center;
    margin-bottom: 40px;
    position: relative;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
    max-width: 200px;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 10px;
    transition: all 0.3s;
}

.step.active .step-number {
    background: #ff6b35;
    color: white;
    transform: scale(1.1);
}

.step.completed .step-number {
    background: #28a745;
    color: white;
}

.step-title {
    font-size: 14px;
    color: #666;
    text-align: center;
    font-weight: 500;
}

.step.active .step-title {
    color: #ff6b35;
    font-weight: bold;
}

.step-line {
    position: absolute;
    top: 20px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: #e9ecef;
    z-index: -1;
}

.step.completed .step-line {
    background: #28a745;
}

.order-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
}

.vehicle-info, .order-info, .payment-info {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.section-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #333;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.vehicle-display {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.vehicle-image {
    width: 200px;
    height: 150px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.vehicle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.vehicle-details {
    flex: 1;
}

.vehicle-title {
    font-size: 18px;
    font-weight: bold;
    color: #333;
    margin-bottom: 15px;
}

.vehicle-specs {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.spec-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #666;
    font-size: 14px;
}

.spec-item .icon {
    width: 20px;
    text-align: center;
}

.vehicle-price {
    font-size: 24px;
    font-weight: bold;
    color: #ff6b35;
    margin-top: 10px;
}

.order-summary {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.price-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 14px;
}

.price-row.total {
    font-weight: bold;
    font-size: 16px;
    color: #333;
    border-top: 1px solid #ddd;
    padding-top: 10px;
    margin-top: 15px;
}

.note-section {
    margin-top: 20px;
}

.note-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    resize: vertical;
    min-height: 80px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.note-textarea:focus {
    outline: none;
    border-color: #ff6b35;
    box-shadow: 0 0 0 2px rgba(255,107,53,0.1);
}

.payment-methods {
    margin-top: 20px;
}

.payment-option {
    display: flex;
    align-items: center;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
}

.payment-option:hover {
    border-color: #ff6b35;
    background: #fff8f5;
}

.payment-option.selected {
    border-color: #ff6b35;
    background: #fff8f5;
}

.payment-option input[type="radio"] {
    margin-right: 15px;
}

.payment-icon {
    width: 30px;
    height: 30px;
    margin-right: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.payment-details {
    flex: 1;
}

.payment-name {
    font-weight: bold;
    color: #333;
    margin-bottom: 2px;
}

.payment-desc {
    font-size: 12px;
    color: #666;
}

.agreement-section {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.checkbox-wrapper {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.checkbox-wrapper input[type="checkbox"] {
    margin-top: 2px;
}

.agreement-text {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
}

.agreement-link {
    color: #ff6b35;
    text-decoration: none;
}

.agreement-link:hover {
    text-decoration: underline;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.btn {
    padding: 15px 30px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    flex: 1;
}

.btn-secondary {
    background: #f5f5f5;
    color: #666;
}

.btn-secondary:hover {
    background: #e8e8e8;
}

.btn-primary {
    background: #ff6b35;
    color: white;
}

.btn-primary:hover {
    background: #e55a2b;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255,107,53,0.3);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.loading {
    display: none;
    text-align: center;
    margin: 20px 0;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #ff6b35;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.toast.success {
    background: #28a745;
}

.toast.error {
    background: #dc3545;
}

.toast.info {
    background: #17a2b8;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-icon {
    font-size: 48px;
    margin-bottom: 20px;
}

.modal-title {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
}

.modal-description {
    color: #666;
    margin-bottom: 25px;
    line-height: 1.5;
}

.modal-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.modal-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-btn-primary {
    background: #ff6b35;
    color: white;
}

.modal-btn-primary:hover {
    background: #e55a2b;
}

.modal-btn-secondary {
    background: #f5f5f5;
    color: #666;
}

.modal-btn-secondary:hover {
    background: #e8e8e8;
}
</style>
{% endblock %}

{% block content %}
<div class="order-container">
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <div class="breadcrumb">
        <a href="/vehicles">æµè§ˆè½¦è¾†</a>
        <span class="separator">></span>
        <a href="/vehicles/{{ vehicle_id }}/">è½¦è¾†è¯¦æƒ…</a>
        <span class="separator">></span>
        <span>ä¸‹å•è´­ä¹°</span>
    </div>

    <!-- è®¢å•æ­¥éª¤ -->
    <div class="order-steps">
        <div class="step active">
            <div class="step-number">1</div>
            <div class="step-title">ç¡®è®¤è®¢å•</div>
        </div>
        <div class="step">
            <div class="step-line"></div>
            <div class="step-number">2</div>
            <div class="step-title">é€‰æ‹©æ”¯ä»˜</div>
        </div>
        <div class="step">
            <div class="step-line"></div>
            <div class="step-number">3</div>
            <div class="step-title">å®Œæˆä¸‹å•</div>
        </div>
    </div>

    <!-- è®¢å•å†…å®¹ -->
    <div class="order-content">
        <!-- å·¦ä¾§ï¼šè½¦è¾†ä¿¡æ¯å’Œè®¢å•å¤‡æ³¨ -->
        <div class="left-column">
            <!-- è½¦è¾†ä¿¡æ¯ -->
            <div class="vehicle-info">
                <h2 class="section-title">è½¦è¾†ä¿¡æ¯</h2>
                <div class="vehicle-display" id="vehicleDisplay">
                    <!-- è½¦è¾†ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½è½¦è¾†ä¿¡æ¯...</p>
                    </div>
                </div>
            </div>

            <!-- è®¢å•å¤‡æ³¨ -->
            <div class="order-info">
                <h2 class="section-title">è®¢å•å¤‡æ³¨</h2>
                <div class="note-section">
                    <label for="buyerNote" style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">
                        ç»™å–å®¶ç•™è¨€ï¼ˆé€‰å¡«ï¼‰
                    </label>
                    <textarea
                        id="buyerNote"
                        class="note-textarea"
                        placeholder="è¯·è¾“å…¥æ‚¨å¯¹å–å®¶çš„ç•™è¨€ï¼Œæ¯”å¦‚å¸Œæœ›çš„çœ‹è½¦æ—¶é—´ã€å…·ä½“è¦æ±‚ç­‰..."
                        maxlength="500"
                    ></textarea>
                    <div style="text-align: right; margin-top: 5px; font-size: 12px; color: #999;">
                        <span id="noteCount">0</span>/500
                    </div>
                </div>
            </div>

            <!-- ä¹°å®¶ä¿¡æ¯ -->
            <div class="order-info">
                <h2 class="section-title">ä¹°å®¶ä¿¡æ¯</h2>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="buyerPhone" style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">
                        ä¹°å®¶ç”µè¯ <span style="color: red;">*</span>
                    </label>
                    <input type="tel" id="buyerPhone" class="form-input note-textarea"
                           placeholder="è¯·è¾“å…¥æ‚¨çš„è”ç³»ç”µè¯" required
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-size: 14px;">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="deliveryAddress" style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">
                        é…é€åœ°å€ <span style="color: red;">*</span>
                    </label>
                    <textarea id="deliveryAddress" class="note-textarea"
                              placeholder="è¯·è¾“å…¥å®Œæ•´çš„é…é€åœ°å€"
                              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px; font-size: 14px;"
                              required></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="deliveryTime" style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">
                        æœŸæœ›é€è¾¾æ—¶é—´ <span style="color: red;">*</span>
                    </label>
                    <input type="datetime-local" id="deliveryTime" class="form-input"
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-size: 14px;"
                           required>
                </div>
            </div>

            <!-- è½¦è¾†ä¿¡æ¯ç¡®è®¤ -->
            <div class="order-info">
                <h2 class="section-title">è½¦è¾†ä¿¡æ¯ç¡®è®¤</h2>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="vehicleColor" style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">
                        è½¦è¾†é¢œè‰² <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="vehicleColor" class="form-input"
                           placeholder="è¯·ç¡®è®¤è½¦è¾†é¢œè‰²ï¼ˆå¦‚ï¼šé»‘è‰²ã€ç™½è‰²ã€çº¢è‰²ç­‰ï¼‰" required
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-size: 14px;">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="vehicleModelType" style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">
                        è½¦è¾†æ¬¾å‹ <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="vehicleModelType" class="form-input"
                           placeholder="è¯·è¾“å…¥è½¦è¾†æ¬¾å‹ï¼ˆå¦‚ï¼š1.5L è‡ªåŠ¨æŒ¡ è±ªåç‰ˆï¼‰" required
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; font-size: 14px;">
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè®¢å•æ±‡æ€»å’Œæ”¯ä»˜æ–¹å¼ -->
        <div class="right-column">
            <!-- è®¢å•æ±‡æ€» -->
            <div class="order-info">
                <h2 class="section-title">è®¢å•æ±‡æ€»</h2>
                <div class="order-summary">
                    <div class="price-row">
                        <span>è½¦è¾†ä»·æ ¼</span>
                        <span id="vehiclePrice">Â¥0</span>
                    </div>
                    <div class="price-row">
                        <span>æœåŠ¡è´¹</span>
                        <span id="serviceFee">Â¥0</span>
                    </div>
                    <div class="price-row">
                        <span>å¹³å°ä¼˜æƒ </span>
                        <span id="discount">-Â¥0</span>
                    </div>
                    <div class="price-row total">
                        <span>åˆè®¡</span>
                        <span id="totalPrice" style="color: #ff6b35;">Â¥0</span>
                    </div>
                </div>

                <!-- æ”¯ä»˜æ–¹å¼ -->
                <div class="payment-methods">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #333;">æ”¯ä»˜æ–¹å¼</h3>

                    <div class="payment-option selected" data-method="wallet">
                        <input type="radio" name="payment_method" value="wallet" checked>
                        <div class="payment-icon">ğŸ’°</div>
                        <div class="payment-details">
                            <div class="payment-name">é’±åŒ…æ”¯ä»˜</div>
                            <div class="payment-desc" id="walletDesc">é’±åŒ…å¯ç”¨ä½™é¢ï¼šåŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- äº¤æ˜“å¯†ç  -->
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">
                        äº¤æ˜“å¯†ç  <span style="color: red;">*</span>
                    </label>
                    <input type="password" id="paymentPassword" maxlength="6" placeholder="è¯·è¾“å…¥6ä½äº¤æ˜“å¯†ç " style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        ä¸ºäº†ä¿æŠ¤æ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œé’±åŒ…æ”¯ä»˜éœ€è¦è¾“å…¥äº¤æ˜“å¯†ç 
                    </div>
                </div>

                <!-- è´­ä¹°åè®® -->
                <div class="agreement-section">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="agreement">
                        <label for="agreement" class="agreement-text">
                            æˆ‘å·²é˜…è¯»å¹¶åŒæ„<a href="#" class="agreement-link">ã€ŠäºŒæ‰‹è½¦è´­ä¹°åè®®ã€‹</a>å’Œ<a href="#" class="agreement-link">ã€Šå¹³å°æœåŠ¡æ¡æ¬¾ã€‹</a>ï¼Œç¡®è®¤è´­ä¹°æ­¤è½¦è¾†ã€‚
                        </label>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="window.history.back()">è¿”å›</button>
                    <button class="btn btn-primary" id="submitOrder" type="button">ä¸‹å•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: #666;">æ­£åœ¨åˆ›å»ºè®¢å•ï¼Œè¯·ç¨å€™...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API_BASE_URL = '/api';
let vehicleData = null;
// å®‰å…¨åˆå§‹åŒ–è½¦è¾†ID
const vehicleId = {% if vehicle_id %}{{ vehicle_id }}{% else %}null{% endif %};

// éªŒè¯vehicleIdæ˜¯å¦æœ‰æ•ˆ
if (!vehicleId || vehicleId === 'undefined' || vehicleId === 'null') {
    console.error('è½¦è¾†IDæœªå®šä¹‰ï¼Œæ— æ³•åŠ è½½è®¢å•é¡µé¢');
    // å°è¯•ä»URLè·å–vehicleId
    const pathParts = window.location.pathname.split('/');
    const potentialId = pathParts[pathParts.length - 2]; // /orders/create/{id}/
    if (potentialId && !isNaN(parseInt(potentialId))) {
        window.vehicleId = parseInt(potentialId);
        console.log('ä»URLè·å–åˆ°è½¦è¾†ID:', window.vehicleId);
    } else {
        showToast('é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°è®¿é—®', 'error');
        setTimeout(() => {
            window.location.href = '/vehicles/';
        }, 2000);
        return;
    }
} else {
    window.vehicleId = vehicleId;
    console.log('ä»æ¨¡æ¿è·å–åˆ°è½¦è¾†ID:', vehicleId);
}

// å…¨å±€å˜é‡å­˜å‚¨ä½™é¢ä¿¡æ¯
let currentWalletBalance = 0;
let hasPaymentPassword = false;
let isSubmitting = false;  // é˜²æ­¢é‡å¤æäº¤

// Toastæ¶ˆæ¯å‡½æ•°
function showToast(message, type = 'info') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async function() {
    console.log('=== é¡µé¢åˆå§‹åŒ–å¼€å§‹ ===');

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    setupEventListeners();

    // åˆå§‹åŒ–é¡µé¢
    await initializePage();

    console.log('=== é¡µé¢åˆå§‹åŒ–å®Œæˆ ===');
});

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    console.log('=== è®¾ç½®äº‹ä»¶ç›‘å¬å™¨ ===');

    // å¤‡æ³¨å­—æ®µè®¡æ•°
    const noteTextarea = document.getElementById('buyerNote');
    const noteCount = document.getElementById('noteCount');

    if (noteTextarea && noteCount) {
        noteTextarea.addEventListener('input', function() {
            const count = this.value.length;
            noteCount.textContent = count;

            if (count > 500) {
                this.value = this.value.substring(0, 500);
                noteCount.textContent = 500;
            }
        });
    }

    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬æ‰€æœ‰è¡¨å•è¾“å…¥å˜åŒ–
    document.addEventListener('input', function(e) {
        const formFieldIds = ['buyerPhone', 'deliveryAddress', 'deliveryTime',
                              'vehicleColor', 'vehicleModelType', 'paymentPassword'];
        if (formFieldIds.includes(e.target.id)) {
            console.log(`å­—æ®µ ${e.target.id} å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€`);
            updateButtonState();
        }
    });

    document.addEventListener('change', function(e) {
        const formFieldIds = ['buyerPhone', 'deliveryAddress', 'deliveryTime',
                              'vehicleColor', 'vehicleModelType', 'paymentPassword', 'agreement'];
        if (formFieldIds.includes(e.target.id)) {
            console.log(`å­—æ®µ ${e.target.id} å‘ç”Ÿå˜åŒ–ï¼ˆchangeäº‹ä»¶ï¼‰ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€`);
            updateButtonState();
        }
    });

    // æäº¤è®¢å•
    const submitBtn = document.getElementById('submitOrder');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            // å¦‚æœæŒ‰é’®è¢«ç¦ç”¨ï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸ºå¹¶æç¤ºç”¨æˆ·
            if (this.disabled) {
                e.preventDefault();
                e.stopPropagation();
                showToast('è¯·å…ˆå¡«å†™å®Œæ•´ä¿¡æ¯', 'info');
                return false;
            }
            submitOrder();
        });
    }

    console.log('=== äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ ===');
}

// åˆå§‹åŒ–é¡µé¢
async function initializePage() {
    console.log('=== åˆå§‹åŒ–é¡µé¢æ•°æ® ===');

    try {
        // å¹¶è¡ŒåŠ è½½è½¦è¾†ä¿¡æ¯å’Œé’±åŒ…ä¿¡æ¯
        const [vehicleResult, walletResult] = await Promise.allSettled([
            loadVehicleInfo(),
            loadWalletBalance()
        ]);

        if (vehicleResult.status === 'rejected') {
            console.error('è½¦è¾†ä¿¡æ¯åŠ è½½å¤±è´¥:', vehicleResult.reason);
            return;
        }

        if (walletResult.status === 'rejected') {
            console.error('é’±åŒ…ä¿¡æ¯åŠ è½½å¤±è´¥:', walletResult.reason);
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateButtonState();

        console.log('=== é¡µé¢æ•°æ®åˆå§‹åŒ–å®Œæˆ ===');

    } catch (error) {
        console.error('=== é¡µé¢åˆå§‹åŒ–å¤±è´¥ ===', error);
        showToast('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
    }
}

// åŠ è½½è½¦è¾†ä¿¡æ¯
async function loadVehicleInfo() {
    console.log('=== å¼€å§‹åŠ è½½è½¦è¾†ä¿¡æ¯ ===');

    if (!window.vehicleId) {
        throw new Error('è½¦è¾†IDæœªå®šä¹‰');
    }

    try {
        console.log(`åŠ è½½è½¦è¾†ID: ${window.vehicleId}`);

        const token = localStorage.getItem('accessToken');
        if (!token) {
            showToast('è¯·å…ˆç™»å½•åå†è®¿é—®æ­¤é¡µé¢', 'error');
            throw new Error('ç”¨æˆ·æœªç™»å½•');
        }

        const response = await fetch(`/api/vehicles/${window.vehicleId}/`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            cache: 'no-store'
        });

        console.log(`è½¦è¾†APIå“åº”çŠ¶æ€: ${response.status}`);

        if (response.status === 401) {
            showToast('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
            setTimeout(() => {
                window.location.href = '/login/';
            }, 2000);
            throw new Error('æœªæˆæƒ');
        }

        if (response.status === 404) {
            showToast('è½¦è¾†ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶', 'error');
            setTimeout(() => {
                window.location.href = '/vehicles/';
            }, 2000);
            throw new Error('è½¦è¾†ä¸å­˜åœ¨');
        }

        if (!response.ok) {
            const errorData = await response.text();
            console.error('APIå“åº”é”™è¯¯:', response.status, errorData);
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        console.log('è½¦è¾†æ•°æ®è·å–æˆåŠŸ:', data);

        // éªŒè¯æ•°æ®å®Œæ•´æ€§
        if (!data.id) {
            throw new Error('è½¦è¾†æ•°æ®æ— æ•ˆ');
        }

        // æ£€æŸ¥ä»·æ ¼
        if (!data.price || data.price === '0' || data.price === 0) {
            console.warn('è­¦å‘Š: è½¦è¾†ä»·æ ¼ä¸º0');
        }

        // æ£€æŸ¥è½¦è¾†çŠ¶æ€
        if (data.review_status !== 'approved') {
            showToast('è¯¥è½¦è¾†å°šæœªé€šè¿‡å®¡æ ¸ï¼Œæ— æ³•è´­ä¹°', 'warning');
            return;
        }

        if (data.status !== 'listed' && data.status !== 'available') {
            showToast('è¯¥è½¦è¾†å·²ä¸‹æ¶ï¼Œæ— æ³•è´­ä¹°', 'warning');
            return;
        }

        vehicleData = data;
        renderVehicleInfo(data);

        console.log('=== è½¦è¾†ä¿¡æ¯åŠ è½½å®Œæˆ ===');
        return data;

    } catch (error) {
        console.error('åŠ è½½è½¦è¾†ä¿¡æ¯å¤±è´¥:', error);
        showToast(`åŠ è½½è½¦è¾†ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');

        // 3ç§’åè¿”å›è½¦è¾†åˆ—è¡¨
        setTimeout(() => {
            window.location.href = '/vehicles/';
        }, 3000);
        throw error;
    }
}

// æ¸²æŸ“è½¦è¾†ä¿¡æ¯ (æ”¹è¿›ç‰ˆæœ¬)
function renderVehicleInfo(vehicle) {
    console.log('å¼€å§‹æ¸²æŸ“è½¦è¾†ä¿¡æ¯:', vehicle);
    console.log('è½¦è¾†ä»·æ ¼åŸå§‹æ•°æ®:', vehicle.price, 'ç±»å‹:', typeof vehicle.price);

    const vehicleDisplay = document.getElementById('vehicleDisplay');
    if (!vehicleDisplay) {
        console.error('vehicleDisplay element not found');
        return;
    }

    const mainPhoto = vehicle.photos && vehicle.photos.find(photo => photo.is_main);
    const photoUrl = mainPhoto ? mainPhoto.image : '/static/images/no-car-image.jpg';

    // ç¡®ä¿ä»·æ ¼æ˜¯æ•°å­—
    const price = parseFloat(vehicle.price) || 0;
    console.log('è½¦è¾†ä»·æ ¼è§£æ:', { original: vehicle.price, parsed: price });

    vehicleDisplay.innerHTML = `
        <div class="vehicle-image">
            <img src="${photoUrl}" alt="${vehicle.brand_name} ${vehicle.model_name}">
        </div>
        <div class="vehicle-details">
            <div class="vehicle-title">${vehicle.brand_name} ${vehicle.model_name}</div>
            <div class="vehicle-specs">
                <div class="spec-item">
                    <span class="icon">D</span>
                    <span>${vehicle.year}å¹´</span>
                </div>
                <div class="spec-item">
                    <span class="icon">K</span>
                    <span>${vehicle.mileage.toLocaleString()}km</span>
                </div>
                <div class="spec-item">
                    <span class="icon">C</span>
                    <span>${vehicle.color}</span>
                </div>
                <div class="spec-item">
                    <span class="icon">G</span>
                    <span>${vehicle.transmission === 'auto' ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'}</span>
                </div>
            </div>
            <div class="vehicle-price">Â¥${price.toLocaleString()}</div>
        </div>
    `;

    // æ›´æ–°å³ä¾§ä»·æ ¼æ±‡æ€»
    updatePriceDisplay(price);

    console.log('è½¦è¾†ä¿¡æ¯æ¸²æŸ“å®Œæˆ');
    updateButtonState();
}

// æ›´æ–°ä»·æ ¼æ˜¾ç¤º (æ”¹è¿›ç‰ˆæœ¬)
function updatePriceDisplay(vehiclePrice) {
    // ä¸¥æ ¼çš„ä»·æ ¼è½¬æ¢
    let price = 0;
    if (typeof vehiclePrice === 'string') {
        price = parseFloat(vehiclePrice);
    } else if (typeof vehiclePrice === 'number') {
        price = vehiclePrice;
    }

    // éªŒè¯ä»·æ ¼
    if (isNaN(price) || price < 0) {
        console.warn('è­¦å‘Š: è½¦è¾†ä»·æ ¼æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼0');
        price = 0;
    }

    // è®¡ç®—æœåŠ¡è´¹ï¼ˆ1%ï¼‰
    const serviceFeeRate = 0.01; // 1%æœåŠ¡è´¹
    const serviceFee = Math.round(price * serviceFeeRate);

    // è®¡ç®—å¹³å°ä¼˜æƒ ï¼ˆåŸºäºè½¦è¾†ä»·æ ¼åŒºé—´ï¼‰
    let discount = 0;
    if (price >= 300000) {
        discount = 2000; // é«˜ç«¯è½¦è¾†ä¼˜æƒ 2000å…ƒ
    } else if (price >= 100000) {
        discount = 1000; // ä¸­ç«¯è½¦è¾†ä¼˜æƒ 1000å…ƒ
    }

    // è®¡ç®—åˆè®¡
    const totalPrice = price + serviceFee - discount;

    // æ›´æ–°DOM
    const vehiclePriceEl = document.getElementById('vehiclePrice');
    const serviceFeeEl = document.getElementById('serviceFee');
    const discountEl = document.getElementById('discount');
    const totalPriceEl = document.getElementById('totalPrice');

    if (vehiclePriceEl) {
        vehiclePriceEl.textContent = `Â¥${price.toLocaleString()}`;
    }
    if (serviceFeeEl) {
        serviceFeeEl.textContent = `Â¥${serviceFee.toLocaleString()}`;
    }
    if (discountEl) {
        discountEl.textContent = `-Â¥${discount.toLocaleString()}`;
    }
    if (totalPriceEl) {
        totalPriceEl.textContent = `Â¥${totalPrice.toLocaleString()}`;
    }

    console.log('ä»·æ ¼æ˜¾ç¤ºå·²æ›´æ–°:', {
        vehiclePrice: price,
        serviceFee: serviceFee,
        discount: discount,
        totalPrice: totalPrice
    });
}

// åŠ è½½é’±åŒ…ä½™é¢
async function loadWalletBalance() {
    console.log('=== å¼€å§‹åŠ è½½é’±åŒ…ä½™é¢ ===');

    try {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            showToast('è¯·å…ˆç™»å½•åå†è®¿é—®æ­¤é¡µé¢', 'error');
            return false;
        }

        const response = await fetch(`/api/users/wallet/`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            cache: 'no-store'
        });

        console.log(`é’±åŒ…APIå“åº”çŠ¶æ€: ${response.status}`);

        if (response.status === 401) {
            showToast('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
            setTimeout(() => {
                window.location.href = '/login/';
            }, 2000);
            throw new Error('æœªæˆæƒ');
        }

        if (!response.ok) {
            showToast('æ— æ³•åŠ è½½é’±åŒ…ä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        console.log('é’±åŒ…æ•°æ®è·å–æˆåŠŸ:', data);

        // æ›´æ–°å…¨å±€å˜é‡
        currentWalletBalance = parseFloat(data.balance) || 0;
        hasPaymentPassword = data.has_payment_password || false;

        // æ›´æ–°UIæ˜¾ç¤º
        const balanceFormatted = currentWalletBalance.toFixed(2);
        const walletDescEl = document.getElementById('walletDesc');
        if (walletDescEl) {
            walletDescEl.textContent = `é’±åŒ…å¯ç”¨ä½™é¢ï¼šÂ¥${balanceFormatted}`;
        }

        console.log(`é’±åŒ…ä½™é¢: Â¥${balanceFormatted}, å¯†ç è®¾ç½®: ${hasPaymentPassword}`);

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateButtonState();

        console.log('=== é’±åŒ…ä½™é¢åŠ è½½å®Œæˆ ===');
        return true;

    } catch (error) {
        console.error('åŠ è½½é’±åŒ…ä½™é¢å¤±è´¥:', error);
        showToast(`åŠ è½½é’±åŒ…ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
        return false;
    }
}

// æ›´æ–°æŒ‰é’®çŠ¶æ€ (æ”¹è¿›ç‰ˆæœ¬)
function updateButtonState() {
    const submitBtn = document.getElementById('submitOrder');

    if (!submitBtn) {
        console.error('é”™è¯¯: submitOrder button element not found!');
        return;
    }

    // æ£€æŸ¥åè®®
    const agreementEl = document.getElementById('agreement');
    const agreement = agreementEl ? agreementEl.checked : false;

    // æ£€æŸ¥è¡¨å•å­—æ®µ
    const buyerPhone = document.getElementById('buyerPhone')?.value?.trim() || '';
    const deliveryAddress = document.getElementById('deliveryAddress')?.value?.trim() || '';
    const deliveryTime = document.getElementById('deliveryTime')?.value || '';
    const vehicleColor = document.getElementById('vehicleColor')?.value?.trim() || '';
    const vehicleModelType = document.getElementById('vehicleModelType')?.value?.trim() || '';
    const paymentPassword = document.getElementById('paymentPassword')?.value || '';

    // è¡¨å•å®Œæ•´æ€§æ£€æŸ¥
    const formComplete = !!(buyerPhone && deliveryAddress && deliveryTime && vehicleColor && vehicleModelType && paymentPassword);

    // æ–°çš„å¯ç”¨æ¡ä»¶: è¡¨å•å®Œæ•´ + åè®®åŒæ„ + è½¦è¾†å·²åŠ è½½
    const canSubmit = formComplete && agreement && vehicleData !== null;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    if (canSubmit) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ä¸‹å•';
        submitBtn.style.backgroundColor = '#ff6b35';
        submitBtn.style.cursor = 'pointer';
        submitBtn.style.opacity = '1';
        console.log('âœ“ æŒ‰é’®å·²å¯ç”¨ï¼Œå¯ä»¥æäº¤è®¢å•');
    } else {
        submitBtn.disabled = true;
        submitBtn.style.cursor = 'not-allowed';
        submitBtn.style.opacity = '0.6';

        // æä¾›æ¸…æ™°çš„æç¤ºæ–‡æœ¬
        if (!vehicleData) {
            submitBtn.textContent = 'åŠ è½½è½¦è¾†ä¿¡æ¯ä¸­...';
            submitBtn.style.backgroundColor = '#ccc';
        } else if (!agreement) {
            submitBtn.textContent = 'è¯·å…ˆåŒæ„è´­ä¹°åè®®';
            submitBtn.style.backgroundColor = '#ffc107';
        } else if (!formComplete) {
            submitBtn.textContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
            submitBtn.style.backgroundColor = '#ffc107';
        } else {
            submitBtn.textContent = 'è¯·ç¨å€™...';
            submitBtn.style.backgroundColor = '#ccc';
        }

        console.log('âŠ˜ æŒ‰é’®å·²ç¦ç”¨', {
            vehicleLoaded: vehicleData !== null,
            agreementChecked: agreement,
            formComplete: formComplete,
            fields: {
                buyerPhone: !!buyerPhone,
                deliveryAddress: !!deliveryAddress,
                deliveryTime: !!deliveryTime,
                vehicleColor: !!vehicleColor,
                vehicleModelType: !!vehicleModelType,
                paymentPassword: !!paymentPassword
            }
        });
    }
}

// æäº¤è®¢å•
async function submitOrder() {
    console.log('=== å¼€å§‹æäº¤è®¢å• ===');

    // é˜²æ­¢é‡å¤æäº¤
    if (isSubmitting) {
        console.log('å·²æœ‰è®¢å•åœ¨å¤„ç†ä¸­ï¼Œå¿½ç•¥æ–°çš„æäº¤');
        return;
    }

    if (!vehicleData) {
        showToast('è½¦è¾†ä¿¡æ¯åŠ è½½å¤±è´¥', 'error');
        console.error('è½¦è¾†ä¿¡æ¯æœªåŠ è½½');
        return;
    }

    console.log(`è½¦è¾†ä¿¡æ¯: ID=${vehicleData.id}, ä»·æ ¼=${vehicleData.price}`);

    // éªŒè¯äº¤æ˜“å¯†ç 
    const paymentPassword = document.getElementById('paymentPassword').value;
    if (!paymentPassword) {
        showToast('è¯·è¾“å…¥äº¤æ˜“å¯†ç ', 'error');
        document.getElementById('paymentPassword').focus();
        return;
    }

    if (!/^\d{6}$/.test(paymentPassword)) {
        showToast('äº¤æ˜“å¯†ç å¿…é¡»æ˜¯6ä½æ•°å­—', 'error');
        return;
    }

    // éªŒè¯ä½™é¢æ˜¯å¦è¶³å¤Ÿ
    const vehiclePrice = parseFloat(vehicleData.price) || 0;
    console.log(`ä½™é¢éªŒè¯: å½“å‰ä½™é¢=${currentWalletBalance}, éœ€è¦=${vehiclePrice}, è¶³å¤Ÿ=${currentWalletBalance >= vehiclePrice}`);
    if (currentWalletBalance < vehiclePrice) {
        const shortage = (vehiclePrice - currentWalletBalance).toFixed(2);
        showToast(`ä½™é¢ä¸è¶³ï¼Œè¿˜éœ€å……å€¼ Â¥${shortage}`, 'error');
        showInsufficientBalanceDialog();
        return;
    }

    console.log('æ‰€æœ‰éªŒè¯é€šè¿‡ï¼Œï¿½ï¿½ç¤ºè´­ä¹°ç¡®è®¤å¯¹è¯æ¡†');
    // æ˜¾ç¤ºè´­ä¹°ç¡®è®¤å¯¹è¯æ¡†
    showPurchaseConfirmDialog();
}

// æ˜¾ç¤ºä½™é¢ä¸è¶³ç¡®è®¤å¯¹è¯æ¡†
function showInsufficientBalanceDialog() {
    console.log('=== æ˜¾ç¤ºä½™é¢ä¸è¶³å¯¹è¯æ¡† ===');

    const currentBalance = currentWalletBalance.toFixed(2);
    const vehiclePrice = parseFloat(vehicleData.price) || 0;
    const requiredAmount = vehiclePrice.toLocaleString();
    const shortage = (vehiclePrice - currentWalletBalance).toFixed(2);

    // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;

    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-icon">ğŸ’”</div>
            <div class="modal-title">ä½™é¢ä¸è¶³ï¼Œæ— æ³•è´­ä¹°</div>
            <div class="modal-description">
                æ‚¨çš„å½“å‰ä½™é¢ä¸º Â¥${currentBalance}ï¼Œ<br>
                è´­ä¹°æ­¤è½¦è¾†éœ€è¦ Â¥${requiredAmount}ï¼Œ<br>
                è¿˜éœ€å……å€¼ Â¥${shortage}ã€‚
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeInsufficientBalanceDialog()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-primary" onclick="goToRecharge()">å……å€¼</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    window.currentModal = modal;

    console.log('ä½™é¢ä¸è¶³å¯¹è¯æ¡†å·²æ˜¾ç¤º');
}

// å…³é—­ä½™é¢ä¸è¶³å¯¹è¯æ¡†
function closeInsufficientBalanceDialog() {
    console.log('å…³é—­ä½™é¢ä¸è¶³å¯¹è¯æ¡†');
    closeModal();
}


// æ˜¾ç¤ºè´­ä¹°ç¡®è®¤å¯¹è¯æ¡†
function showPurchaseConfirmDialog() {
    const currentBalance = currentWalletBalance.toFixed(2);
    const vehiclePrice = parseFloat(vehicleData.price) || 0;
    const vehiclePriceStr = vehiclePrice.toLocaleString();
    const remainingBalance = (currentWalletBalance - vehiclePrice).toFixed(2);

    // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;

    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-icon">âœ…</div>
            <div class="modal-title">ç¡®è®¤è´­ä¹°</div>
            <div class="modal-description">
                <div style="text-align: left; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">è´­ä¹°è½¦è¾†ï¼š</span>
                        <span style="font-weight: bold;">${vehicleData.brand_name} ${vehicleData.model_name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">è½¦è¾†ä»·æ ¼ï¼š</span>
                        <span style="color: #ff6b35; font-weight: bold;">Â¥${vehiclePriceStr}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">å½“å‰ä½™é¢ï¼š</span>
                        <span>Â¥${currentBalance}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">è´­ä¹°åä½™é¢ï¼š</span>
                        <span style="color: #28a745; font-weight: bold;">Â¥${remainingBalance}</span>
                    </div>
                </div>
                ç¡®è®¤è¦è´­ä¹°æ­¤è½¦è¾†å—ï¼Ÿ
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-primary" onclick="executePurchase()">ç¡®è®¤è´­ä¹°</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    window.currentModal = modal;
}

// æ‰§è¡Œè´­ä¹°
async function executePurchase() {
    console.log('=== å¼€å§‹æ‰§è¡Œè´­ä¹° ===');

    // è®¾ç½®æäº¤æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤æäº¤
    isSubmitting = true;

    closeModal(); // å…³é—­ç¡®è®¤å¯¹è¯æ¡†
    showLoading(); // æ˜¾ç¤ºåŠ è½½çŠ¶æ€

    try {
        // æ”¶é›†è¡¨å•æ•°æ®
        const paymentPassword = document.getElementById('paymentPassword').value;
        const buyerPhone = document.getElementById('buyerPhone').value.trim();
        const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
        const deliveryTime = document.getElementById('deliveryTime').value;
        const vehicleColor = document.getElementById('vehicleColor').value.trim();
        const vehicleModelType = document.getElementById('vehicleModelType').value.trim();
        const buyerNote = document.getElementById('buyerNote').value;

        // æ„å»ºè®¢å•æ•°æ®
        const orderData = {
            vehicle: window.vehicleId,
            price: vehicleData.price,
            buyer_note: buyerNote,
            payment_password: paymentPassword,
            buyer_phone: buyerPhone,
            delivery_address: deliveryAddress,
            delivery_time: deliveryTime,
            vehicle_color: vehicleColor,
            vehicle_model_type: vehicleModelType
        };

        console.log('è®¢å•æ•°æ®:', orderData);

        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(orderData)
        });

        console.log(`è®¢å•åˆ›å»ºå“åº”çŠ¶æ€: ${response.status}`);

        const result = await response.json();

        if (response.ok) {
            // è´­ä¹°æˆåŠŸï¼
            showPurchaseSuccessDialog();

            // æ›´æ–°æœ¬åœ°ä½™é¢å˜é‡
            currentWalletBalance -= parseFloat(vehicleData.price) || 0;
            const newBalance = currentWalletBalance;

            // ä½¿ç”¨ç»Ÿä¸€çš„é’±åŒ…ç®¡ç†ç³»ç»Ÿæ›´æ–°ä½™é¢
            if (API && API.WalletManager) {
                API.WalletManager.updateWalletBalance(newBalance);
            }

            // æ›´æ–°é¡µé¢ä½™é¢æ˜¾ç¤º
            const walletDescEl = document.getElementById('walletDesc');
            if (walletDescEl) {
                walletDescEl.textContent = `é’±åŒ…å¯ç”¨ä½™é¢ï¼šÂ¥${newBalance.toFixed(2)}`;
            }

            console.log('è´­ä¹°æˆåŠŸï¼Œä½™é¢å·²æ›´æ–°:', newBalance);

        } else {
            console.error('è®¢å•åˆ›å»ºå¤±è´¥:', result);
            const errorMessage = result.error || result.message || result.detail || 'è®¢å•åˆ›å»ºå¤±è´¥';
            showToast(errorMessage, 'error');
        }

    } catch (error) {
        console.error('æäº¤è®¢å•å¤±è´¥:', error);
        showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    } finally {
        hideLoading(); // éšè—åŠ è½½çŠ¶æ€
        isSubmitting = false; // é‡ç½®æäº¤æ ‡å¿—
    }
}

// æ˜¾ç¤ºè´­ä¹°æˆåŠŸå¯¹è¯æ¡†
function showPurchaseSuccessDialog() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;

    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-icon">ğŸ‰</div>
            <div class="modal-title">è´­ä¹°æˆåŠŸï¼</div>
            <div class="modal-description">
                æ­å–œæ‚¨æˆåŠŸè´­ä¹°æ­¤è½¦è¾†ï¼<br>
                æˆ‘ä»¬å°†å°½å¿«å®‰æ’é…é€äº‹å®œã€‚
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="goToOrders()">æŸ¥çœ‹è®¢å•</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    window.currentModal = modal;
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal() {
    if (window.currentModal) {
        window.currentModal.remove();
        window.currentModal = null;
    }
}

// å»å……å€¼
function goToRecharge() {
    closeModal();
    window.location.href = '/wallet/';
}

// æŸ¥çœ‹è®¢å•
function goToOrders() {
    closeModal();
    window.location.href = '/orders/';
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading() {
    const loading = document.getElementById('loading');
    if (loading) {
        loading.style.display = 'block';
    }
}

// éšè—åŠ è½½çŠ¶æ€
function hideLoading() {
    const loading = document.getElementById('loading');
    if (loading) {
        loading.style.display = 'none';
    }
}

// åˆå§‹åŒ–é’±åŒ…ä½™é¢ç›‘å¬å™¨
if (API && API.WalletManager) {
    // ç›‘å¬é’±åŒ…ä½™é¢æ›´æ–°äº‹ä»¶
    window.addEventListener('walletBalanceUpdated', function(event) {
        console.log('ç›‘å¬åˆ°é’±åŒ…ä½™é¢æ›´æ–°äº‹ä»¶:', event.detail);
        currentWalletBalance = parseFloat(event.detail.balance);
        hasPaymentPassword = event.detail.hasPassword;

        // æ›´æ–°é¡µé¢æ˜¾ç¤º
        const balanceFormatted = currentWalletBalance.toFixed(2);
        const walletDescEl = document.getElementById('walletDesc');
        if (walletDescEl) {
            walletDescEl.textContent = `é’±åŒ…å¯ç”¨ä½™é¢ï¼šÂ¥${balanceFormatted}`;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateButtonState();
    });

    // åˆå§‹åŒ–é’±åŒ…ç›‘å¬å™¨
    API.WalletManager.initWalletListeners();

    // ç«‹å³åŠ è½½é’±åŒ…ä¿¡æ¯
    API.WalletManager.getWalletBalance().then(walletInfo => {
        currentWalletBalance = walletInfo.balance;
        hasPaymentPassword = walletInfo.hasPassword;

        // æ›´æ–°é¡µé¢æ˜¾ç¤º
        const balanceFormatted = currentWalletBalance.toFixed(2);
        const walletDescEl = document.getElementById('walletDesc');
        if (walletDescEl) {
            walletDescEl.textContent = `é’±åŒ…å¯ç”¨ä½™é¢ï¼šÂ¥${balanceFormatted}`;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateButtonState();
    }).catch(error => {
        console.error('åˆå§‹åŒ–é’±åŒ…ä¿¡æ¯å¤±è´¥:', error);
    });
}
</script>
{% endblock %}