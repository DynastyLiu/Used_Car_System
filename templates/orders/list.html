{% extends "base.html" %}
{% load static %}

{% block title %}æˆ‘çš„è®¢å• - äºŒæ‰‹è½¦é›†å¸‚ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
.orders-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-title {
    font-size: 32px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
}

.page-subtitle {
    color: #666;
    font-size: 16px;
}

.order-tabs {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.tab-buttons {
    display: flex;
    gap: 10px;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 15px;
    margin-bottom: 20px;
}

.tab-btn {
    padding: 10px 20px;
    border: none;
    background: transparent;
    color: #666;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    border-radius: 6px;
}

.tab-btn:hover {
    background: #f8f9fa;
}

.tab-btn.active {
    background: #ff6b35;
    color: white;
}

.filter-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.filter-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-select, .filter-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.filter-input {
    width: 250px;
    padding: 8px 15px;
    border-radius: 20px;
}

.order-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 36px;
    font-weight: bold;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    opacity: 0.9;
}

.orders-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.order-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s;
    border-left: 4px solid #e9ecef;
}

.order-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.order-card.status-pending_payment {
    border-left-color: #ffc107;
}

.order-card.status-paid {
    border-left-color: #17a2b8;
}

.order-card.status-trading {
    border-left-color: #007bff;
}

.order-card.status-completed {
    border-left-color: #28a745;
}

.order-card.status-cancelled {
    border-left-color: #6c757d;
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.order-number {
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

.order-status {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
    color: white;
}

.vehicle-info {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.vehicle-image {
    width: 80px;
    height: 60px;
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
}

.vehicle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.vehicle-details {
    flex: 1;
}

.vehicle-title {
    font-size: 14px;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.vehicle-specs {
    font-size: 12px;
    color: #666;
}

.order-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
}

.detail-label {
    color: #666;
}

.detail-value {
    color: #333;
    font-weight: 500;
}

.price-value {
    color: #ff6b35;
    font-weight: bold;
}

.order-actions {
    display: flex;
    gap: 10px;
}

.action-btn {
    flex: 1;
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
}

.btn-view {
    background: #e3f2fd;
    color: #1976d2;
}

.btn-view:hover {
    background: #1976d2;
    color: white;
}

.btn-cancel {
    background: #ffebee;
    color: #d32f2f;
}

.btn-cancel:hover {
    background: #d32f2f;
    color: white;
}

.btn-confirm {
    background: #e8f5e8;
    color: #2e7d32;
}

.btn-confirm:hover {
    background: #2e7d32;
    color: white;
}

.btn-ship {
    background: #fff3e0;
    color: #f57c00;
}

.btn-ship:hover {
    background: #f57c00;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 80px 20px;
    color: #666;
}

.empty-icon {
    font-size: 80px;
    color: #ddd;
    margin-bottom: 20px;
}

.empty-title {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
    color: #333;
}

.empty-description {
    font-size: 16px;
    margin-bottom: 30px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.6;
}

.loading {
    text-align: center;
    padding: 60px;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #ff6b35;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 30px;
}

.pagination button {
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s;
}

.pagination button:hover:not(:disabled) {
    background: #f5f5f5;
}

.pagination button.active {
    background: #ff6b35;
    color: white;
    border-color: #ff6b35;
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.toast.success {
    background: #28a745;
}

.toast.error {
    background: #dc3545;
}

.toast.info {
    background: #17a2b8;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@media (max-width: 768px) {
    .filter-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .order-details {
        grid-template-columns: 1fr;
    }

    .order-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="orders-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <h1 class="page-title">æˆ‘çš„è®¢å•</h1>
        <p class="page-subtitle">ç®¡ç†æ‚¨çš„è´­ä¹°å’Œé”€å”®è®¢å•</p>
    </div>

    <!-- è®¢å•ç»Ÿè®¡ -->
    <div class="order-stats" id="orderStats">
        <div class="stat-card">
            <div class="stat-number" id="totalOrders">0</div>
            <div class="stat-label">è®¢å•æ€»æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingOrders">0</div>
            <div class="stat-label">å¾…å¤„ç†</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="completedOrders">0</div>
            <div class="stat-label">å·²å®Œæˆ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalAmount">0</div>
            <div class="stat-label">äº¤æ˜“æ€»é¢(ä¸‡)</div>
        </div>
    </div>

    <!-- è®¢å•é€‰é¡¹å¡ -->
    <div class="order-tabs">
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="buyer" onclick="switchTab('buyer')">æˆ‘çš„è´­ä¹°</button>
            <button class="tab-btn" data-tab="seller" onclick="switchTab('seller')">æˆ‘çš„é”€å”®</button>
        </div>

        <!-- ç­›é€‰æ§åˆ¶ -->
        <div class="filter-controls">
            <div class="filter-group">
                <label style="font-weight: 500;">çŠ¶æ€ç­›é€‰</label>
                <select class="filter-select" id="statusFilter">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="pending_payment">å¾…ä»˜æ¬¾</option>
                    <option value="paid">å·²ä»˜æ¬¾</option>
                    <option value="trading">äº¤æ˜“ä¸­</option>
                    <option value="completed">å·²å®Œæˆ</option>
                    <option value="cancelled">å·²å–æ¶ˆ</option>
                </select>
            </div>

            <div class="filter-group">
                <label style="font-weight: 500;">æ—¶é—´æ’åº:</label>
                <select class="filter-select" id="sortFilter">
                    <option value="-created_at">æœ€æ–°è®¢å•</option>
                    <option value="created_at">æœ€æ—©è®¢å•</option>
                    <option value="price">ä»·æ ¼ä»ä½åˆ°é«˜</option>
                    <option value="-price">ä»·æ ¼ä»é«˜åˆ°ä½</option>
                </select>
            </div>

            <div class="filter-group" style="margin-left: auto;">
                <input type="text" class="filter-input" id="searchInput" placeholder="æœç´¢è®¢å•å·ã€è½¦è¾†å“ç‰Œ...">
            </div>
        </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #666;">åŠ è½½è®¢å•åˆ—è¡¨...</p>
    </div>

    <!-- è®¢å•åˆ—è¡¨ -->
    <div class="orders-grid" id="ordersGrid">
        <!-- è®¢å•å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">ğŸ“‹</div>
        <h2 class="empty-title">æš‚æ— è®¢å•</h2>
        <p class="empty-description">
            æ‚¨è¿˜æ²¡æœ‰ç›¸å…³çš„è®¢å•ï¼Œèµ¶å¿«å»æµè§ˆè½¦è¾†å¹¶ä¸‹æ‚¨çš„ç¬¬ä¸€å•å§ï¼
        </p>
        <a href="/vehicles" class="btn btn-primary" style="padding: 12px 30px;">å»æµè§ˆè½¦è¾†</a>
    </div>

    <!-- åˆ†é¡µ -->
    <div class="pagination" id="pagination">
        <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTab = 'buyer';
let currentPage = 1;
let pageSize = 10;
let totalOrders = 0;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    setupEventListeners();
});

// åˆå§‹åŒ–é¡µé¢
async function initializePage() {
    await loadOrders();
}

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    document.getElementById('statusFilter').addEventListener('change', loadOrders);
    document.getElementById('sortFilter').addEventListener('change', loadOrders);

    // æœç´¢æ¡†è¾“å…¥äº‹ä»¶
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadOrders, 500);
    });
}

// åˆ‡æ¢é€‰é¡¹å¡
function switchTab(tab) {
    currentTab = tab;
    currentPage = 1;

    // æ›´æ–°é€‰é¡¹å¡æ ·å¼
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
            btn.classList.add('active');
        }
    });

    loadOrders();
}

// åŠ è½½è®¢å•åˆ—è¡¨
async function loadOrders() {
    const loading = document.getElementById('loading');
    const ordersGrid = document.getElementById('ordersGrid');
    const emptyState = document.getElementById('emptyState');

    loading.style.display = 'block';
    ordersGrid.innerHTML = '';
    emptyState.style.display = 'none';

    try {
        const params = new URLSearchParams({
            page: currentPage,
            page_size: pageSize
        });

        // æ·»åŠ ç­›é€‰å‚æ•°
        const status = document.getElementById('statusFilter').value;
        const sort = document.getElementById('sortFilter').value;
        const search = document.getElementById('searchInput').value.trim();

        if (status) params.append('status', status);
        if (sort) params.append('ordering', sort);
        if (search) params.append('search', search);

        // æ ¹æ®å½“å‰é€‰é¡¹å¡é€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹
        const endpoint = currentTab === 'buyer' ? 'my_orders' : 'selling_orders';
        const response = await fetch(`/api/orders/${endpoint}/?${params}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            totalOrders = data.count || 0;

            if (data.results && data.results.length > 0) {
                renderOrders(data.results);
                updateStatistics(data.results);
                renderPagination();
            } else {
                showEmptyState();
            }
        } else if (response.status === 401) {
            showToast('è¯·å…ˆç™»å½•', 'error');
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        } else {
            throw new Error('åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
        showToast('åŠ è½½è®¢å•åˆ—è¡¨å¤±è´¥', 'error');
    } finally {
        loading.style.display = 'none';
    }
}

// æ¸²æŸ“è®¢å•åˆ—è¡¨
function renderOrders(orders) {
    const ordersGrid = document.getElementById('ordersGrid');

    orders.forEach(order => {
        const card = createOrderCard(order);
        ordersGrid.appendChild(card);
    });
}

// åˆ›å»ºè®¢å•å¡ç‰‡
function createOrderCard(order) {
    const card = document.createElement('div');
    card.className = `order-card status-${order.status}`;

    const vehicle = order.vehicle_info;
    const photoUrl = vehicle.main_photo || '/static/images/no-car-image.jpg';

    card.innerHTML = `
        <div class="order-header">
            <div class="order-number">${order.order_number}</div>
            <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
        </div>

        <div class="vehicle-info">
            <div class="vehicle-image">
                <img src="${photoUrl}" alt="${vehicle.brand_name} ${vehicle.model_name}">
            </div>
            <div class="vehicle-details">
                <div class="vehicle-title">${vehicle.brand_name} ${vehicle.model_name}</div>
                <div class="vehicle-specs">
                    ${vehicle.year}å¹´ | ${vehicle.mileage.toLocaleString()}km
                </div>
            </div>
        </div>

        <div class="order-details">
            <div class="detail-item">
                <span class="detail-label">è®¢å•é‡‘é¢</span>
                <span class="detail-value price-value">Â¥${order.price.toLocaleString()}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">ä¸‹å•æ—¶é—´</span>
                <span class="detail-value">${formatDateTime(order.created_at)}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">${currentTab === 'buyer' ? 'å–å®¶' : 'ä¹°å®¶'}</span>
                <span class="detail-value">${currentTab === 'buyer' ? order.seller_name : order.buyer_name}</span>
            </div>
            ${order.paid_at ? `
            <div class="detail-item">
                <span class="detail-label">ä»˜æ¬¾æ—¶é—´</span>
                <span class="detail-value">${formatDateTime(order.paid_at)}</span>
            </div>
            ` : ''}
        </div>

        <div class="order-actions">
            ${getActionButtons(order)}
        </div>
    `;

    return card;
}

// è·å–æ“ä½œæŒ‰é’®
function getActionButtons(order) {
    let buttons = [];

    // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
    buttons.push('<button class="action-btn btn-view" onclick="viewOrderDetail(' + order.id + ')">æŸ¥çœ‹è¯¦æƒ…</button>');

    // æ ¹æ®è®¢å•çŠ¶æ€å’Œç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒæŒ‰é’®
    if (currentTab === 'buyer') {
        if (order.can_cancel) {
            buttons.push('<button class="action-btn btn-cancel" onclick="cancelOrder(' + order.id + ')">å–æ¶ˆè®¢å•</button>');
        }
        if (order.can_confirm) {
            buttons.push('<button class="action-btn btn-confirm" onclick="confirmReceipt(' + order.id + ')">ç¡®è®¤æ”¶è´§</button>');
        }
        if (order.can_review) {
            buttons.push('<button class="action-btn btn-view" onclick="reviewOrder(' + order.id + ')">è¯„ä»·è®¢å•</button>');
        }
    } else {
        // å–å®¶æ“ä½œ
        if (order.status === 'paid') {
            buttons.push('<button class="action-btn btn-ship" onclick="shipOrder(' + order.id + ')">å‘è´§</button>');
        }
    }

    return buttons.map(btn => `<div style="flex: 1;">${btn}</div>`).join('');
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        'pending_payment': 'å¾…ä»˜æ¬¾',
        'paid': 'å·²ä»˜æ¬¾',
        'trading': 'äº¤æ˜“ä¸­',
        'completed': 'å·²å®Œæˆ',
        'cancelled': 'å·²å–æ¶ˆ'
    };
    return statusMap[status] || status;
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN');
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®
function updateStatistics(orders) {
    const total = orders.length;
    const pending = orders.filter(o => o.status === 'pending_payment').length;
    const completed = orders.filter(o => o.status === 'completed').length;

    let totalAmount = 0;
    orders.forEach(order => {
        if (order.status === 'completed') {
            totalAmount += order.price;
        }
    });

    document.getElementById('totalOrders').textContent = total;
    document.getElementById('pendingOrders').textContent = pending;
    document.getElementById('completedOrders').textContent = completed;
    document.getElementById('totalAmount').textContent = (totalAmount / 10000).toFixed(1);
}

// æ˜¾ç¤ºç©ºçŠ¶æ€
function showEmptyState() {
    document.getElementById('emptyState').style.display = 'block';
}

// æ¸²æŸ“åˆ†é¡µ
function renderPagination() {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(totalOrders / pageSize);

    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }

    pagination.style.display = 'flex';
    pagination.innerHTML = '';

    // ä¸Šä¸€é¡µæŒ‰é’®
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'ä¸Šä¸€é¡µ';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => changePage(currentPage - 1);
    pagination.appendChild(prevBtn);

    // é¡µç æŒ‰é’®
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? 'active' : '';
        pageBtn.onclick = () => changePage(i);
        pagination.appendChild(pageBtn);
    }

    // ä¸‹ä¸€é¡µæŒ‰é’®
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => changePage(currentPage + 1);
    pagination.appendChild(nextBtn);
}

// åˆ‡æ¢é¡µé¢
function changePage(page) {
    if (page < 1 || page > Math.ceil(totalOrders / pageSize)) return;
    currentPage = page;
    loadOrders();
}

// æŸ¥çœ‹è®¢å•è¯¦æƒ…
function viewOrderDetail(orderId) {
    window.location.href = `/orders/${orderId}/`;
}

// å–æ¶ˆè®¢å•
async function cancelOrder(orderId) {
    if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch(`/api/orders/${orderId}/cancel/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
            }
        });

        if (response.ok) {
            showToast('è®¢å•å·²å–æ¶ˆ', 'success');
            loadOrders(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } else {
            const error = await response.json();
            showToast(error.error || 'å–æ¶ˆå¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('å–æ¶ˆè®¢å•å¤±è´¥:', error);
        showToast('å–æ¶ˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// ç¡®è®¤æ”¶è´§
async function confirmReceipt(orderId) {
    if (!confirm('ç¡®å®šè¦ç¡®è®¤æ”¶è´§å—ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch(`/api/orders/${orderId}/confirm_receipt/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
            }
        });

        if (response.ok) {
            showToast('æ”¶è´§ç¡®è®¤æˆåŠŸ', 'success');
            loadOrders(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } else {
            const error = await response.json();
            showToast(error.error || 'ç¡®è®¤å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('ç¡®è®¤æ”¶è´§å¤±è´¥:', error);
        showToast('ç¡®è®¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// å‘è´§
async function shipOrder(orderId) {
    if (!confirm('ç¡®å®šè¦å‘è´§å—ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch(`/api/orders/${orderId}/ship/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
            }
        });

        if (response.ok) {
            showToast('å‘è´§æˆåŠŸ', 'success');
            loadOrders(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } else {
            const error = await response.json();
            showToast(error.error || 'å‘è´§å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('å‘è´§å¤±è´¥:', error);
        showToast('å‘è´§å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// è¯„ä»·è®¢å•
function reviewOrder(orderId) {
    showToast('è¯„ä»·åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message, type = 'success') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}