{% extends "base.html" %}

{% block title %}å–å®¶ä¸­å¿ƒ - äºŒæ‰‹è½¦é›†å¸‚{% endblock %}

{% block content %}
<style>
    .dashboard-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 30px;
        min-height: 80vh;
    }

    .sidebar {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        height: fit-content;
        position: sticky;
        top: 20px;
    }

    .main-content {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .nav-item {
        display: block;
        padding: 12px 16px;
        margin-bottom: 5px;
        color: #333;
        text-decoration: none;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .nav-item:hover {
        background: #e9ecef;
        color: #007BFF;
        transform: translateX(5px);
    }

    .nav-item.active {
        background: #007BFF;
        color: white;
    }

    .nav-item i {
        margin-right: 8px;
        width: 20px;
        display: inline-block;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-card.green {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
    }

    .stat-card.blue {
        background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
    }

    .stat-card.orange {
        background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
    }

    .stat-number {
        font-size: 36px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }

    .section {
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .action-btn {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        text-decoration: none;
        color: #333;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        border-color: #007BFF;
        color: #007BFF;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,123,255,0.1);
    }

    .action-btn i {
        font-size: 32px;
        margin-bottom: 10px;
        display: block;
    }

    .action-btn-title {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .vehicles-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .vehicles-table th,
    .vehicles-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .vehicles-table th {
        background: #f8f9fa;
        font-weight: bold;
    }

    .vehicle-image {
        width: 60px;
        height: 45px;
        object-fit: cover;
        border-radius: 4px;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }

    .status-pending {
        background: #ffc107;
        color: #333;
    }

    .status-approved {
        background: #28a745;
        color: white;
    }

    .status-rejected {
        background: #dc3545;
        color: white;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .btn-primary {
        background: #007BFF;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    @media (max-width: 768px) {
        .dashboard-container {
            grid-template-columns: 1fr;
        }

        .sidebar {
            position: static;
        }
    }
</style>

<div class="dashboard-container">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <h3 style="margin-bottom: 20px;">å–å®¶ä¸­å¿ƒ</h3>
        <a href="#overview" class="nav-item active">
            <i>ğŸ“Š</i>æ¦‚è§ˆ
        </a>
        <a href="#vehicles" class="nav-item">
            <i>ğŸš—</i>æˆ‘çš„è½¦è¾†
        </a>
        <a href="#orders" class="nav-item">
            <i>ğŸ“‹</i>è®¢å•ç®¡ç†
        </a>
        <a href="#pricing" class="nav-item">
            <i>ğŸ’°</i>å®šä»·ç®¡ç†
        </a>
        <a href="#reviews" class="nav-item">
            <i>â­</i>è¯„ä»·ç®¡ç†
        </a>
        <a href="#analytics" class="nav-item">
            <i>ğŸ“ˆ</i>æ•°æ®åˆ†æ
        </a>
        <a href="#profile" class="nav-item">
            <i>ğŸ‘¤</i>ä¸ªäººä¿¡æ¯
        </a>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- æ¦‚è§ˆéƒ¨åˆ† -->
        <div id="overview" class="section">
            <h1 class="section-title">å–å®¶ä¸­å¿ƒ</h1>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-vehicles">0</div>
                    <div class="stat-label">åœ¨å”®è½¦è¾†</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="sold-vehicles">0</div>
                    <div class="stat-label">å·²å”®è½¦è¾†</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-number" id="pending-orders">0</div>
                    <div class="stat-label">å¾…å¤„ç†è®¢å•</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="total-revenue">0</div>
                    <div class="stat-label">æ€»æ”¶å…¥</div>
                </div>
            </div>

            <!-- å¿«æ·æ“ä½œ -->
            <div class="actions-grid">
                <a href="#" class="action-btn" onclick="showSection('add-vehicle')">
                    <i>â•</i>
                    <div class="action-btn-title">å‘å¸ƒæ–°è½¦è¾†</div>
                </a>
                <a href="#vehicles" class="action-btn">
                    <i>ğŸ”§</i>
                    <div class="action-btn-title">ç®¡ç†è½¦è¾†</div>
                </a>
                <a href="#orders" class="action-btn">
                    <i>ğŸ“‹</i>
                    <div class="action-btn-title">æŸ¥çœ‹è®¢å•</div>
                </a>
                <a href="#" class="action-btn">
                    <i>ğŸ“ˆ</i>
                    <div class="action-btn-title">æ•°æ®åˆ†æ</div>
                </a>
            </div>
        </div>

        <!-- è½¦è¾†ç®¡ç† -->
        <div id="vehicles" class="section">
            <h2 class="section-title">è½¦è¾†ç®¡ç†</h2>
            <div id="vehicles-loading" class="loading">æ­£åœ¨åŠ è½½è½¦è¾†åˆ—è¡¨...</div>

            <div id="vehicles-content" style="display: none;">
                <div id="empty-vehicles" style="display: none; text-align: center; padding: 40px;">
                    <h3>æš‚æ— è½¦è¾†</h3>
                    <p>æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•è½¦è¾†ï¼Œèµ¶å¿«å‘å¸ƒæ‚¨çš„ç¬¬ä¸€è¾†è½¦å§ï¼</p>
                    <button class="btn-primary" onclick="showSection('add-vehicle')" style="margin-top: 20px;">å‘å¸ƒç¬¬ä¸€è¾†è½¦</button>
                </div>

                <div id="vehicles-table-container" style="display: none;">
                    <table class="vehicles-table">
                        <thead>
                            <tr>
                                <th>è½¦è¾†</th>
                                <th>ä»·æ ¼</th>
                                <th>çŠ¶æ€</th>
                                <th>æµè§ˆé‡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="vehicles-tbody">
                            <!-- è½¦è¾†åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- è®¢å•ç®¡ç† -->
        <div id="orders" class="section" style="display: none;">
            <h2 class="section-title">è®¢å•ç®¡ç†</h2>
            <div id="orders-loading" class="loading">æ­£åœ¨åŠ è½½è®¢å•...</div>
            <div id="orders-content" style="display: none;">
                <div id="empty-orders" style="display: none; text-align: center; padding: 40px;">
                    <h3>æš‚æ— è®¢å•</h3>
                    <p>æ‚¨è¿˜æ²¡æœ‰ä»»ä½•è®¢å•</p>
                </div>
                <div id="orders-table-container" style="display: none;">
                    <table class="vehicles-table">
                        <thead>
                            <tr>
                                <th>è®¢å•å·</th>
                                <th>è½¦è¾†</th>
                                <th>ä¹°å®¶</th>
                                <th>ä»·æ ¼</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å®šä»·ç®¡ç† -->
        <div id="pricing" class="section" style="display: none;">
            <h2 class="section-title">å®šä»·ç®¡ç†</h2>
            <div id="pricing-loading" class="loading">æ­£åœ¨åŠ è½½å®šä»·æ•°æ®...</div>
            <div id="pricing-content" style="display: none;">
                <div id="empty-pricing" style="display: none; text-align: center; padding: 40px;">
                    <h3>æš‚æ— å®šä»·æ•°æ®</h3>
                    <p>è¯·å…ˆå‘å¸ƒè½¦è¾†ä»¥æŸ¥çœ‹å®šä»·å»ºè®®</p>
                </div>
                <div id="pricing-table-container" style="display: none;">
                    <table class="vehicles-table">
                        <thead>
                            <tr>
                                <th>è½¦è¾†</th>
                                <th>å½“å‰ä»·æ ¼</th>
                                <th>AIå»ºè®®ä»·æ ¼</th>
                                <th>å¸‚åœºå‡ä»·</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="pricing-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- è¯„ä»·ç®¡ç† -->
        <div id="reviews" class="section" style="display: none;">
            <h2 class="section-title">è¯„ä»·ç®¡ç†</h2>
            <div id="reviews-loading" class="loading">æ­£åœ¨åŠ è½½è¯„ä»·...</div>
            <div id="reviews-content" style="display: none;">
                <div id="empty-reviews" style="display: none; text-align: center; padding: 40px;">
                    <h3>æš‚æ— è¯„ä»·</h3>
                    <p>æš‚æ—¶è¿˜æ²¡æœ‰ä¹°å®¶ç»™æ‚¨çš„è¯„ä»·</p>
                </div>
                <div id="reviews-container" style="display: none;">
                    <!-- è¯„ä»·å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- æ•°æ®åˆ†æ -->
        <div id="analytics" class="section" style="display: none;">
            <h2 class="section-title">æ•°æ®åˆ†æ</h2>
            <div id="analytics-loading" class="loading">æ­£åœ¨åŠ è½½åˆ†ææ•°æ®...</div>
            <div id="analytics-content" style="display: none;">
                <!-- åˆ†ææ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- ä¸ªäººä¿¡æ¯ -->
        <div id="profile" class="section" style="display: none;">
            <h2 class="section-title">ä¸ªäººä¿¡æ¯</h2>
            <div id="profile-loading" class="loading">æ­£åœ¨åŠ è½½ä¸ªäººä¿¡æ¯...</div>
            <div id="profile-content" style="display: none;">
                <!-- ä¸ªäººä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- å‘å¸ƒè½¦è¾†è¡¨å• -->
        <div id="add-vehicle" class="section" style="display: none;">
            <h2 class="section-title">å‘å¸ƒæ–°è½¦è¾†</h2>
            <form id="add-vehicle-form">
                <div class="form-group">
                    <label class="form-label">è½¦è¾†å“ç‰Œ</label>
                    <select class="form-control" id="brand" name="brand" required>
                        <option value="">è¯·é€‰æ‹©å“ç‰Œ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">è½¦è¾†å‹å·</label>
                    <input type="text" class="form-control" id="model" name="model" placeholder="ä¾‹å¦‚ï¼šA4L 2023æ¬¾" required>
                </div>

                <div class="form-group">
                    <label class="form-label">å¹´ä»½</label>
                    <select class="form-control" id="year" name="year" required>
                        <option value="">è¯·é€‰æ‹©å¹´ä»½</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ä»·æ ¼</label>
                    <input type="number" class="form-control" id="price" name="price" placeholder="è¯·è¾“å…¥ä»·æ ¼" required>
                </div>

                <div class="form-group">
                    <label class="form-label">é‡Œç¨‹æ•°</label>
                    <input type="number" class="form-control" id="mileage" name="mileage" placeholder="è¯·è¾“å…¥é‡Œç¨‹æ•°">
                </div>

                <div class="form-group">
                    <label class="form-label">è½¦è¾†æè¿°</label>
                    <textarea class="form-control" id="description" name="description" rows="4" placeholder="è¯·æè¿°è½¦è¾†çŠ¶å†µã€é…ç½®ç­‰ä¿¡æ¯"></textarea>
                </div>

                <button type="submit" class="btn-primary">å‘å¸ƒè½¦è¾†</button>
            </form>
        </div>
    </div>
</div>

<script>
// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadSellerStats();
    loadVehicles();
    setupNavigation();
    setupAddVehicleForm();

    // ä¸ºå„ä¸ªå¯¼èˆªé¡¹è®¾ç½®ç‚¹å‡»æ—¶çš„æ•°æ®åŠ è½½
    document.querySelector('a[href="#orders"]').addEventListener('click', function() {
        setTimeout(loadOrders, 100);
    });
    document.querySelector('a[href="#pricing"]').addEventListener('click', function() {
        setTimeout(loadPricing, 100);
    });
    document.querySelector('a[href="#reviews"]').addEventListener('click', function() {
        setTimeout(loadReviews, 100);
    });
    document.querySelector('a[href="#analytics"]').addEventListener('click', function() {
        setTimeout(loadAnalytics, 100);
    });
    document.querySelector('a[href="#profile"]').addEventListener('click', function() {
        setTimeout(loadProfile, 100);
    });
});

function extractResults(payload) {
    if (!payload) {
        return [];
    }
    if (Array.isArray(payload)) {
        return payload;
    }
    if (Array.isArray(payload.results)) {
        return payload.results;
    }
    if (Array.isArray(payload.data)) {
        return payload.data;
    }
    return [];
}

function extractStats(payload) {
    if (payload && typeof payload === 'object' && payload.stats) {
        return payload.stats;
    }
    return null;
}

function toNumber(value) {
    if (value === null || value === undefined || value === '') {
        return 0;
    }
    const num = Number(value);
    return Number.isFinite(num) ? num : 0;
}

function formatCurrency(value) {
    const amount = toNumber(value);
    return amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
}

// å¯¼èˆªè®¾ç½®
function setupNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    const sections = document.querySelectorAll('.section');

    navItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();

            const targetId = this.getAttribute('href').substring(1);
            showSection(targetId);

            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            navItems.forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

// æ˜¾ç¤ºæŒ‡å®šéƒ¨åˆ†
function showSection(sectionId) {
    // éšè—æ‰€æœ‰éƒ¨åˆ†
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });

    // æ˜¾ç¤ºç›®æ ‡éƒ¨åˆ†
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.style.display = 'block';
    }
}

// åŠ è½½å–å®¶ç»Ÿè®¡
async function loadSellerStats() {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/seller/stats/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const stats = await response.json();
            document.getElementById('total-vehicles').textContent = stats.total_vehicles || 0;
            document.getElementById('sold-vehicles').textContent = stats.sold_vehicles || 0;
            document.getElementById('pending-orders').textContent = stats.pending_orders || 0;
            document.getElementById('total-revenue').textContent = formatCurrency(stats.total_revenue || 0);
        }
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
}

// åŠ è½½è½¦è¾†åˆ—è¡¨
async function loadVehicles() {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/seller/vehicles/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const loadingEl = document.getElementById('vehicles-loading');
        const contentEl = document.getElementById('vehicles-content');
        const emptyEl = document.getElementById('empty-vehicles');
        const tableEl = document.getElementById('vehicles-table-container');

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

        if (response.ok) {
            const payload = await response.json();
            const vehicles = extractResults(payload);

            if (vehicles.length === 0) {
                emptyEl.style.display = 'block';
                tableEl.style.display = 'none';
            } else {
                emptyEl.style.display = 'none';
                tableEl.style.display = 'block';
                renderVehiclesTable(vehicles);
            }
        } else {
            throw new Error('åŠ è½½è½¦è¾†å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½è½¦è¾†å¤±è´¥:', error);
        document.getElementById('vehicles-loading').innerHTML = '<p style="color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
    }
}

// æ¸²æŸ“è½¦è¾†è¡¨æ ¼
function renderVehiclesTable(vehicles) {
    const tbody = document.getElementById('vehicles-tbody');
    tbody.innerHTML = '';

    vehicles.forEach(vehicle => {
        const price = toNumber(vehicle.price);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${vehicle.main_photo || '/static/images/placeholder.png'}"
                         alt="${vehicle.model_name}" class="vehicle-image">
                    <div>
                        <div style="font-weight: bold;">${vehicle.brand_name} ${vehicle.model_name}</div>
                        <div style="color: #666; font-size: 12px;">${vehicle.year}å¹´</div>
                    </div>
                </div>
            </td>
            <td><strong>Â¥${formatCurrency(price)}</strong></td>
            <td>
                <span class="status-badge status-${vehicle.status}">
                    ${vehicle.status_display || getStatusText(vehicle.status)}
                </span>
            </td>
            <td>${vehicle.view_count || 0}</td>
            <td>
                <button onclick="editVehicle(${vehicle.id})" class="btn-primary" style="margin-right: 5px;">ç¼–è¾‘</button>
                <button onclick="deleteVehicle(${vehicle.id})" class="btn-primary" style="background: #dc3545;">åˆ é™¤</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        draft: 'è‰ç¨¿',
        pending_review: 'å¾…å®¡æ ¸',
        listed: 'åœ¨å”®',
        sold: 'å·²å”®',
        delisted: 'å·²ä¸‹æ¶',
        rejected: 'å·²æ‹’ç»'
    };
    return statusMap[status] || status;
}

// è®¾ç½®å‘å¸ƒè½¦è¾†è¡¨å•
function setupAddVehicleForm() {
    const form = document.getElementById('add-vehicle-form');

    // åŠ è½½å“ç‰Œåˆ—è¡¨
    loadBrands();
    loadYears();

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        try {
            const token = localStorage.getItem('accessToken');
            const response = await fetch('/api/seller/vehicles/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert('è½¦è¾†å‘å¸ƒæˆåŠŸï¼');
                form.reset();
                showSection('overview');
                loadSellerStats();
                loadVehicles();
            } else {
                const error = await response.json();
                alert('å‘å¸ƒå¤±è´¥ï¼š' + (error.detail || 'è¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯'));
            }
        } catch (error) {
            console.error('å‘å¸ƒè½¦è¾†å¤±è´¥:', error);
            alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}

// åŠ è½½å“ç‰Œåˆ—è¡¨
async function loadBrands() {
    const brandSelect = document.getElementById('brand');
    if (!brandSelect) {
        return;
    }

    try {
        let nextUrl = '/api/vehicles/brands/';
        const collectedBrands = [];

        while (nextUrl) {
            const response = await fetch(nextUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            const pageBrands = Array.isArray(data)
                ? data
                : Array.isArray(data.results) ? data.results : [];

            collectedBrands.push(...pageBrands);

            nextUrl = data && data.next ? data.next : null;
        }

        brandSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å“ç‰Œ</option>';

        collectedBrands
            .filter(brand => brand && brand.name && brand.is_active !== false)
            .sort((a, b) => a.name.localeCompare(b.name, 'zh-Hans-CN'))
            .forEach(brand => {
                const option = document.createElement('option');
                option.value = brand.id;
                option.textContent = brand.name;
                brandSelect.appendChild(option);
            });
    } catch (error) {
        console.error('åŠ è½½å“ç‰Œå¤±è´¥:', error);
    }
}

// åŠ è½½å¹´ä»½é€‰é¡¹
function loadYears() {
    const yearSelect = document.getElementById('year');
    const currentYear = new Date().getFullYear();

    for (let year = currentYear; year >= 2000; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + 'å¹´';
        yearSelect.appendChild(option);
    }
}

// ç¼–è¾‘è½¦è¾†
function editVehicle(vehicleId) {
    window.location.href = `/vehicles/${vehicleId}/edit/`;
}

// åˆ é™¤è½¦è¾†
async function deleteVehicle(vehicleId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™è¾†è½¦å—ï¼Ÿ')) {
        return;
    }

    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch(`/api/seller/vehicles/${vehicleId}/`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            alert('è½¦è¾†åˆ é™¤æˆåŠŸ');
            loadVehicles();
            loadSellerStats();
        } else {
            alert('åˆ é™¤å¤±è´¥');
        }
    } catch (error) {
        console.error('åˆ é™¤è½¦è¾†å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

// åŠ è½½è®¢å•åˆ—è¡¨
async function loadOrders() {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/seller/orders/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const loadingEl = document.getElementById('orders-loading');
        const contentEl = document.getElementById('orders-content');
        const emptyEl = document.getElementById('empty-orders');
        const tableEl = document.getElementById('orders-table-container');

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

        if (response.ok) {
            const payload = await response.json();
            const orders = extractResults(payload);

            if (orders.length === 0) {
                emptyEl.style.display = 'block';
                tableEl.style.display = 'none';
            } else {
                emptyEl.style.display = 'none';
                tableEl.style.display = 'block';
                renderOrdersTable(orders);
            }
        } else {
            throw new Error('åŠ è½½è®¢å•å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
        document.getElementById('orders-loading').innerHTML = '<p style="color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p>';
    }
}

function renderOrdersTable(orders) {
    const tbody = document.getElementById('orders-tbody');
    tbody.innerHTML = '';

    orders.forEach(order => {
        const price = toNumber(order.price);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${order.id}</td>
            <td>${order.vehicle_name || order.vehicle_title || 'è½¦è¾†'}</td>
            <td>${order.buyer_name || 'ä¹°å®¶'}</td>
            <td>Â¥${formatCurrency(price)}</td>
            <td>
                <span class="status-badge status-${order.status}">
                    ${order.status_display || getOrderStatusText(order.status)}
                </span>
            </td>
            <td>
                <button class="btn-primary" onclick="viewOrderDetail(${order.id})" style="margin-right: 5px;">æŸ¥çœ‹</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function getOrderStatusText(status) {
    const statusMap = {
        pending_payment: 'å¾…ä»˜æ¬¾',
        paid: 'å·²ä»˜æ¬¾',
        trading: 'äº¤æ˜“ä¸­',
        completed: 'å·²å®Œæˆ',
        cancelled: 'å·²å–æ¶ˆ'
    };
    return statusMap[status] || status;
}

async function loadPricing() {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/seller/pricing/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const loadingEl = document.getElementById('pricing-loading');
        const contentEl = document.getElementById('pricing-content');
        const emptyEl = document.getElementById('empty-pricing');
        const tableEl = document.getElementById('pricing-table-container');

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

        if (response.ok) {
            const payload = await response.json();
            const pricings = extractResults(payload);

            if (pricings.length === 0) {
                emptyEl.style.display = 'block';
                tableEl.style.display = 'none';
            } else {
                emptyEl.style.display = 'none';
                tableEl.style.display = 'block';
                renderPricingTable(pricings);
            }
        } else {
            throw new Error('åŠ è½½å®šä»·å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½å®šä»·å¤±è´¥:', error);
        document.getElementById('pricing-loading').innerHTML = '<p style="color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p>';
    }
}

function renderPricingTable(pricings) {
    const tbody = document.getElementById('pricing-tbody');
    tbody.innerHTML = '';

    pricings.forEach(pricing => {
        const currentPrice = toNumber(pricing.current_price);
        const suggestedPrice = toNumber(pricing.ai_suggested_price ?? pricing.suggested_price ?? pricing.current_price);
        const marketPrice = toNumber(pricing.market_avg_price ?? suggestedPrice);
        const priceDiff = suggestedPrice - currentPrice;
        const diffPercent = currentPrice > 0 ? ((priceDiff / currentPrice) * 100).toFixed(1) : '0.0';
        const trendColor = priceDiff >= 0 ? '#28a745' : '#dc3545';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${pricing.vehicle_name || pricing.vehicle_title || 'è½¦è¾†'}</td>
            <td>Â¥${formatCurrency(currentPrice)}</td>
            <td>Â¥${formatCurrency(suggestedPrice)} <span style="color: ${trendColor}; font-size: 12px;">${priceDiff >= 0 ? '+' : ''}${diffPercent}%</span></td>
            <td>Â¥${formatCurrency(marketPrice)}</td>
            <td>
                <button class="btn-primary" onclick="updatePrice(${pricing.id})" style="margin-right: 5px;">æ›´æ–°ä»·æ ¼</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

async function loadReviews() {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/seller/reviews/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const loadingEl = document.getElementById('reviews-loading');
        const contentEl = document.getElementById('reviews-content');
        const emptyEl = document.getElementById('empty-reviews');
        const containerEl = document.getElementById('reviews-container');

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

        if (response.ok) {
            const payload = await response.json();
            const reviews = extractResults(payload);

            if (reviews.length === 0) {
                emptyEl.style.display = 'block';
                containerEl.style.display = 'none';
            } else {
                emptyEl.style.display = 'none';
                containerEl.style.display = 'block';
                renderReviews(reviews);
            }
        } else {
            throw new Error('åŠ è½½è¯„ä»·å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½è¯„ä»·å¤±è´¥:', error);
        document.getElementById('reviews-loading').innerHTML = '<p style="color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p>';
    }
}

function renderReviews(reviews) {
    const container = document.getElementById('reviews-container');
    container.innerHTML = '';

    reviews.forEach(review => {
        const reviewEl = document.createElement('div');
        reviewEl.style.cssText = 'border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px;';

        const reviewer = review.reviewer_name || 'ä¹°å®¶';
        const rating = review.rating || 5;
        const createdAt = review.created_at ? new Date(review.created_at).toLocaleString() : '';
        const content = review.content || 'æš‚æ— è¯„è®º';
        const reply = review.reply_content;

        reviewEl.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: bold;">${reviewer} - ${rating}â˜…</div>
                <small style="color: #666;">${createdAt}</small>
            </div>
            <p style="margin: 10px 0; color: #333;">${content}</p>
            ${reply ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;"><strong>å–å®¶å›å¤:</strong> ${reply}</div>` : `<button class="btn-primary" onclick="replyReview(${review.id})" style="margin-top: 10px;">å›å¤</button>`}
        `;

        container.appendChild(reviewEl);
    });
}

async function loadAnalytics() {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/seller/analytics/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const loadingEl = document.getElementById('analytics-loading');
        const contentEl = document.getElementById('analytics-content');

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

        if (response.ok) {
            const analytics = await response.json();
            renderAnalytics(analytics);
        } else {
            throw new Error('åŠ è½½åˆ†æå¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½åˆ†æå¤±è´¥:', error);
        document.getElementById('analytics-loading').innerHTML = '<p style="color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p>';
    }
}

function renderAnalytics(analytics) {
    const container = document.getElementById('analytics-content');
    const kpis = analytics.kpis || {};
    const period = analytics.period || '';

    const totalRevenue = formatCurrency(kpis.total_revenue || 0);
    const totalOrders = kpis.total_orders || 0;
    const avgPrice = formatCurrency(kpis.avg_price || 0);
    const conversionRate = `${(Number(kpis.conversion_rate) || 0).toFixed(2)}%`;

    container.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">Â¥${totalRevenue}</div>
                <div class="stat-label">æ€»æ”¶å…¥</div>
            </div>
            <div class="stat-card green">
                <div class="stat-number">${totalOrders}</div>
                <div class="stat-label">æ€»è®¢å•</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-number">Â¥${avgPrice}</div>
                <div class="stat-label">å¹³å‡ä»·æ ¼</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-number">${conversionRate}</div>
                <div class="stat-label">è½¬åŒ–ç‡</div>
            </div>
        </div>
        ${period ? `<p style="margin-top: 10px; color: #666;">ç»Ÿè®¡å‘¨æœŸ: ${period}</p>` : ''}
    `;
}

async function loadProfile() {
    try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch('/api/users/profile/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const loadingEl = document.getElementById('profile-loading');
        const contentEl = document.getElementById('profile-content');

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

        if (response.ok) {
            const profile = await response.json();
            renderProfile(profile);
        } else {
            throw new Error('åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('profile-loading').innerHTML = '<p style="color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p>';
    }
}

function renderProfile(profile) {
    const container = document.getElementById('profile-content');
    container.innerHTML = `
        <div style="max-width: 600px;">
            <div class="form-group">
                <label class="form-label">ç”¨æˆ·å</label>
                <input type="text" class="form-control" value="${profile.username || ''}" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">é‚®ç®±</label>
                <input type="email" class="form-control" value="${profile.email || ''}" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">æ‰‹æœºå·</label>
                <input type="tel" class="form-control" value="${profile.phone || ''}" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">ç”¨æˆ·ç±»å‹</label>
                <input type="text" class="form-control" value="${profile.user_type_display || profile.user_type || ''}" readonly>
            </div>
            <button class="btn-primary" onclick="window.location.href='/profile/'">ç¼–è¾‘ä¸ªäººä¿¡æ¯</button>
        </div>
    `;
}

function viewOrderDetail(orderId) {
    window.location.href = `/orders/${orderId}/`;
}

async function updatePrice(pricingId) {
    try {
        // è·å–å½“å‰ä»·æ ¼ä¿¡æ¯
        const currentRow = event.target.closest('tr');
        const currentPriceText = currentRow.cells[1].textContent; // å½“å‰ä»·æ ¼åˆ—
        const currentPrice = parseFloat(currentPriceText.replace(/[Â¥,]/g, ''));

        // æ˜¾ç¤ºä»·æ ¼æ›´æ–°å¯¹è¯æ¡†
        const newPrice = prompt(`è¯·è¾“å…¥æ–°ä»·æ ¼ (å½“å‰ä»·æ ¼: Â¥${formatCurrency(currentPrice)}):`);

        if (newPrice === null) {
            // ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ
            return;
        }

        if (!newPrice || isNaN(newPrice) || parseFloat(newPrice) <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼ˆå¤§äº0çš„æ•°å­—ï¼‰');
            return;
        }

        const priceValue = parseFloat(newPrice);

        // è¯¢é—®æ›´æ”¹åŸå› 
        const changeReason = prompt('è¯·è¾“å…¥ä»·æ ¼æ›´æ”¹åŸå› ï¼ˆå¯é€‰ï¼‰:') || 'æ‰‹åŠ¨è°ƒæ•´ä»·æ ¼';

        // ç¡®è®¤æ“ä½œ
        const confirmed = confirm(
            `ç¡®è®¤å°†ä»·æ ¼ä» Â¥${formatCurrency(currentPrice)} æ›´æ”¹ä¸º Â¥${formatCurrency(priceValue)} å—ï¼Ÿ\næ›´æ”¹åŸå› : ${changeReason}`
        );

        if (!confirmed) {
            return;
        }

        // å‘é€APIè¯·æ±‚
        const token = localStorage.getItem('accessToken');
        const response = await fetch(`/api/seller/pricing/${pricingId}/update_vehicle_price/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                new_price: priceValue,
                change_reason: changeReason
            })
        });

        const result = await response.json();

        if (response.ok) {
            alert(`ä»·æ ¼æ›´æ–°æˆåŠŸï¼\næ—§ä»·æ ¼: Â¥${formatCurrency(result.old_price)}\næ–°ä»·æ ¼: Â¥${formatCurrency(result.new_price)}`);

            // é‡æ–°åŠ è½½å®šä»·æ•°æ®ä»¥æ˜¾ç¤ºæœ€æ–°ä»·æ ¼
            await loadPricing();

            // åŒæ—¶åˆ·æ–°å…¶ä»–å¯èƒ½æ˜¾ç¤ºä»·æ ¼çš„åŒºåŸŸ
            await refreshPriceRelatedData();

        } else {
            alert(`ä»·æ ¼æ›´æ–°å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
        }

    } catch (error) {
        console.error('æ›´æ–°ä»·æ ¼æ—¶å‡ºé”™:', error);
        alert('ä»·æ ¼æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// åˆ·æ–°ä»·æ ¼ç›¸å…³çš„æ•°æ®
async function refreshPriceRelatedData() {
    try {
        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        await loadSellerStats();

        // å¦‚æœè½¦è¾†é¡µé¢å½“å‰å¯è§ï¼Œä¹Ÿåˆ·æ–°è½¦è¾†æ•°æ®
        const vehiclesSection = document.getElementById('vehicles');
        if (vehiclesSection && vehiclesSection.style.display !== 'none') {
            await loadVehicles();
        }

        console.log('ä»·æ ¼ç›¸å…³æ•°æ®å·²åˆ·æ–°');
    } catch (error) {
        console.warn('åˆ·æ–°ä»·æ ¼ç›¸å…³æ•°æ®æ—¶å‡ºé”™:', error);
    }
}

function replyReview(reviewId) {
    const reply = prompt('è¯·è¾“å…¥å›å¤å†…å®¹:');
    if (reply) {
        alert('å›å¤åŠŸèƒ½å¼€å‘ä¸­');
    }
}
</script>

{% endblock %}
