{% extends "base.html" %}
{% load static %}

{% block title %}æˆ‘çš„è½¦è¾† - äºŒæ‰‹è½¦é›†å¸‚ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
.vehicles-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.page-title {
    font-size: 24px;
    font-weight: bold;
    color: #333;
}

.vehicle-filters {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.filter-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-item label {
    font-size: 14px;
    color: #666;
}

.filter-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-width: 120px;
}

.search-box {
    margin-left: auto;
}

.search-input {
    padding: 8px 15px;
    border: 1px solid #ddd;
    border-radius: 20px;
    width: 250px;
}

.vehicle-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 32px;
    font-weight: bold;
    color: #ff6b35;
}

.stat-label {
    color: #666;
    margin-top: 5px;
}

.vehicle-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.vehicle-card {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s;
}

.vehicle-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.vehicle-image {
    position: relative;
    height: 200px;
    overflow: hidden;
}

.vehicle-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.vehicle-status {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    color: white;
}

.status-pending {
    background: #ffc107;
}

.status-approved {
    background: #28a745;
}

.status-rejected {
    background: #dc3545;
}

.status-listed {
    background: #007bff;
}

.status-sold {
    background: #6c757d;
}

.vehicle-info {
    padding: 15px;
}

.vehicle-title {
    font-size: 16px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.vehicle-specs {
    display: flex;
    gap: 15px;
    color: #666;
    font-size: 14px;
    margin-bottom: 10px;
}

.vehicle-price {
    font-size: 20px;
    font-weight: bold;
    color: #ff6b35;
    margin-bottom: 15px;
}

.vehicle-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #999;
}

.vehicle-actions {
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
}

.action-btn {
    flex: 1;
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-edit {
    background: #e3f2fd;
    color: #1976d2;
}

.btn-edit:hover {
    background: #1976d2;
    color: white;
}

.btn-delete {
    background: #ffebee;
    color: #d32f2f;
}

.btn-delete:hover {
    background: #d32f2f;
    color: white;
}

.btn-view {
    background: #f5f5f5;
    color: #666;
}

.btn-view:hover {
    background: #666;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-icon {
    font-size: 64px;
    color: #ddd;
    margin-bottom: 20px;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 30px;
}

.pagination button {
    padding: 8px 15px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
}

.pagination button:hover {
    background: #f5f5f5;
}

.pagination button.active {
    background: #ff6b35;
    color: white;
    border-color: #ff6b35;
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.loading {
    text-align: center;
    padding: 40px;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #ff6b35;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="vehicles-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <h1 class="page-title">æˆ‘çš„è½¦è¾†</h1>
        <a href="/vehicles/publish/" class="btn btn-primary">å‘å¸ƒæ–°è½¦</a>
    </div>

    <!-- è½¦è¾†ç»Ÿè®¡ -->
    <div class="vehicle-stats">
        <div class="stat-card">
            <div class="stat-number" id="totalVehicles">0</div>
            <div class="stat-label">è½¦è¾†æ€»æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="listedVehicles">0</div>
            <div class="stat-label">åœ¨å”®è½¦è¾†</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="soldVehicles">0</div>
            <div class="stat-label">å·²å”®è½¦è¾†</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingVehicles">0</div>
            <div class="stat-label">å¾…å®¡æ ¸</div>
        </div>
    </div>

    <!-- ç­›é€‰æ§ä»¶ -->
    <div class="vehicle-filters">
        <div class="filter-row">
            <div class="filter-item">
                <label>è½¦è¾†çŠ¶æ€</label>
                <select class="filter-select" id="statusFilter">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="pending_review">å¾…å®¡æ ¸</option>
                    <option value="listed">åœ¨å”®</option>
                    <option value="sold">å·²å”®</option>
                    <option value="delisted">å·²ä¸‹æ¶</option>
                    <option value="rejected">å®¡æ ¸æ‹’ç»</option>
                </select>
            </div>
            <div class="filter-item">
                <label>å“ç‰Œ</label>
                <select class="filter-select" id="brandFilter">
                    <option value="">å…¨éƒ¨å“ç‰Œ</option>
                </select>
            </div>
            <div class="filter-item">
                <label>æ’åº</label>
                <select class="filter-select" id="sortFilter">
                    <option value="-created_at">æœ€æ–°å‘å¸ƒ</option>
                    <option value="created_at">æœ€æ—©å‘å¸ƒ</option>
                    <option value="price">ä»·æ ¼ä»ä½åˆ°é«˜</option>
                    <option value="-price">ä»·æ ¼ä»é«˜åˆ°ä½</option>
                    <option value="mileage">é‡Œç¨‹ä»ä½åˆ°é«˜</option>
                    <option value="-mileage">é‡Œç¨‹ä»é«˜åˆ°ä½</option>
                </select>
            </div>
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢è½¦å‹ã€VINç ...">
            </div>
        </div>
    </div>

    <!-- è½¦è¾†åˆ—è¡¨ -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: #666;">åŠ è½½ä¸­...</p>
    </div>

    <div class="vehicle-grid" id="vehicleGrid">
        <!-- è½¦è¾†å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </div>

    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">ğŸš—</div>
        <h3>æš‚æ— è½¦è¾†ä¿¡æ¯</h3>
        <p>æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•è½¦è¾†ï¼Œç‚¹å‡»å³ä¸Šè§’å‘å¸ƒæŒ‰é’®å¼€å§‹å‘å¸ƒæ‚¨çš„ç¬¬ä¸€è¾†è½¦</p>
        <a href="/vehicles/publish/" class="btn btn-primary">ç«‹å³å‘å¸ƒ</a>
    </div>

    <!-- åˆ†é¡µ -->
    <div class="pagination" id="pagination">
        <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let pageSize = 12;
let totalVehicles = 0;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    setupEventListeners();
});

// åˆå§‹åŒ–é¡µé¢
async function initializePage() {
    await loadBrands();
    await loadVehicles();
}

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    document.getElementById('statusFilter').addEventListener('change', loadVehicles);
    document.getElementById('brandFilter').addEventListener('change', loadVehicles);
    document.getElementById('sortFilter').addEventListener('change', loadVehicles);

    // æœç´¢æ¡†è¾“å…¥äº‹ä»¶
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadVehicles, 500);
    });
}

// åŠ è½½å“ç‰Œåˆ—è¡¨
async function loadBrands() {
    try {
        // å°è¯•å¤šä¸ªå¯èƒ½çš„APIç«¯ç‚¹
        const apiEndpoints = [
            '/api/vehicles/brands/',
            `${window.API_BASE_URL || '/api'}/vehicles/brands/`
        ];

        let data = null;
        let workingEndpoint = null;

        for (const endpoint of apiEndpoints) {
            try {
                console.log(`å°è¯•è·å–å“ç‰Œæ•°æ®: ${endpoint}`);
                const response = await fetch(endpoint);

                if (response.ok) {
                    data = await response.json();
                    workingEndpoint = endpoint;
                    console.log(`æˆåŠŸè·å–å“ç‰Œæ•°æ®:`, data);
                    break;
                } else {
                    console.warn(`ç«¯ç‚¹ ${endpoint} è¿”å›çŠ¶æ€: ${response.status}`);
                }
            } catch (endpointError) {
                console.warn(`ç«¯ç‚¹ ${endpoint} è¯·æ±‚å¤±è´¥:`, endpointError);
                continue;
            }
        }

        if (!data) {
            throw new Error('æ‰€æœ‰APIç«¯ç‚¹éƒ½æ— æ³•è®¿é—®');
        }

        const brandFilter = document.getElementById('brandFilter');
        brandFilter.innerHTML = '<option value="">å…¨éƒ¨å“ç‰Œ</option>'; // é‡ç½®é€‰é¡¹

        // å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
        const brands = Array.isArray(data) ? data : (data.results || []);

        if (brands.length === 0) {
            console.warn('å“ç‰Œåˆ—è¡¨ä¸ºç©º');
            const option = document.createElement('option');
            option.value = "";
            option.textContent = 'æš‚æ— å“ç‰Œæ•°æ®';
            brandFilter.appendChild(option);
            return;
        }

        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand.id;
            option.textContent = brand.name;
            brandFilter.appendChild(option);
        });

        console.log(`æˆåŠŸåŠ è½½ ${brands.length} ä¸ªå“ç‰Œ`);

    } catch (error) {
        console.error('åŠ è½½å“ç‰Œå¤±è´¥:', error);
        const brandFilter = document.getElementById('brandFilter');
        brandFilter.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';

        // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
        showError('åŠ è½½å“ç‰Œåˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
}

// åŠ è½½è½¦è¾†åˆ—è¡¨
async function loadVehicles() {
    const loading = document.getElementById('loading');
    const vehicleGrid = document.getElementById('vehicleGrid');
    const emptyState = document.getElementById('emptyState');

    loading.style.display = 'block';
    vehicleGrid.innerHTML = '';
    emptyState.style.display = 'none';

    try {
        const params = new URLSearchParams({
            page: currentPage,
            page_size: pageSize
        });

        // æ·»åŠ ç­›é€‰å‚æ•°
        const status = document.getElementById('statusFilter').value;
        const brand = document.getElementById('brandFilter').value;
        const sort = document.getElementById('sortFilter').value;
        const search = document.getElementById('searchInput').value.trim();

        if (status) params.append('status', status);
        if (brand) params.append('brand', brand);
        if (sort) params.append('ordering', sort);
        if (search) params.append('search', search);

        const token = localStorage.getItem('accessToken') || '';
        if (!token) {
            throw new Error('è¯·å…ˆç™»å½•');
        }

        // å°è¯•å¤šä¸ªå¯èƒ½çš„APIç«¯ç‚¹
        const apiEndpoints = [
            `/api/vehicles/my_vehicles/?${params}`,
            `/api/seller/vehicles/?${params}`,
            `/api/vehicles/?${params}&seller=true`
        ];

        let response = null;
        let data = null;

        for (const endpoint of apiEndpoints) {
            try {
                console.log(`å°è¯•APIç«¯ç‚¹: ${endpoint}`);
                response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    data = await response.json();
                    console.log('æˆåŠŸè·å–è½¦è¾†æ•°æ®:', data);
                    break;
                } else {
                    console.warn(`ç«¯ç‚¹ ${endpoint} è¿”å›çŠ¶æ€: ${response.status}`);
                }
            } catch (endpointError) {
                console.warn(`ç«¯ç‚¹ ${endpoint} è¯·æ±‚å¤±è´¥:`, endpointError);
                continue;
            }
        }

        if (!response || !response.ok) {
            throw new Error('æ— æ³•åŠ è½½è½¦è¾†æ•°æ®ï¼Œè¯·æ£€æŸ¥æƒé™å’Œç½‘ç»œè¿æ¥');
        }

        totalVehicles = data.count || 0;

        if (data.results && data.results.length > 0) {
            renderVehicles(data.results);
            updateStatistics(data.results);
            renderPagination();
        } else {
            showEmptyState();
        }

    } catch (error) {
        console.error('åŠ è½½è½¦è¾†å¤±è´¥:', error);
        showError('åŠ è½½è½¦è¾†åˆ—è¡¨å¤±è´¥: ' + error.message);
    } finally {
        loading.style.display = 'none';
    }
}

// æ¸²æŸ“è½¦è¾†åˆ—è¡¨
function renderVehicles(vehicles) {
    const vehicleGrid = document.getElementById('vehicleGrid');

    vehicles.forEach(vehicle => {
        const card = createVehicleCard(vehicle);
        vehicleGrid.appendChild(card);
    });
}

// åˆ›å»ºè½¦è¾†å¡ç‰‡
function createVehicleCard(vehicle) {
    const card = document.createElement('div');
    card.className = 'vehicle-card';

    const mainPhoto = vehicle.photos && vehicle.photos.find(photo => photo.is_main);
    const photoUrl = mainPhoto ? mainPhoto.image : '/static/images/no-car-image.jpg';

    const statusClass = getStatusClass(vehicle.status);
    const statusText = getStatusText(vehicle.status);

    card.innerHTML = `
        <div class="vehicle-image">
            <img src="${photoUrl}" alt="${vehicle.model_name}">
            <span class="vehicle-status ${statusClass}">${statusText}</span>
        </div>
        <div class="vehicle-info">
            <div class="vehicle-title" title="${vehicle.brand_name} ${vehicle.model_name}">
                ${vehicle.brand_name} ${vehicle.model_name}
            </div>
            <div class="vehicle-specs">
                <span>${vehicle.year}å¹´</span>
                <span>${vehicle.mileage.toLocaleString()}km</span>
                <span>${vehicle.color}</span>
            </div>
            <div class="vehicle-price">Â¥${vehicle.price.toLocaleString()}</div>
            <div class="vehicle-meta">
                <span>å‘å¸ƒæ—¶é—´: ${formatDate(vehicle.created_at)}</span>
                <span>æµè§ˆ: ${vehicle.view_count || 0}</span>
            </div>
        </div>
        <div class="vehicle-actions">
            <button class="action-btn btn-view" onclick="viewVehicle(${vehicle.id})">æŸ¥çœ‹</button>
            <button class="action-btn btn-edit" onclick="editVehicle(${vehicle.id})">ç¼–è¾‘</button>
            <button class="action-btn btn-delete" onclick="deleteVehicle(${vehicle.id})">åˆ é™¤</button>
        </div>
    `;

    return card;
}

// è·å–çŠ¶æ€æ ·å¼ç±»
function getStatusClass(status) {
    const statusMap = {
        'pending_review': 'status-pending',
        'listed': 'status-approved',
        'sold': 'status-sold',
        'delisted': 'status-rejected',
        'rejected': 'status-rejected'
    };
    return statusMap[status] || 'status-pending';
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        'pending_review': 'å¾…å®¡æ ¸',
        'listed': 'åœ¨å”®',
        'sold': 'å·²å”®',
        'delisted': 'å·²ä¸‹æ¶',
        'rejected': 'å®¡æ ¸æ‹’ç»'
    };
    return statusMap[status] || 'æœªçŸ¥';
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN');
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®
function updateStatistics(vehicles) {
    const stats = {
        total: vehicles.length,
        listed: vehicles.filter(v => v.status === 'listed').length,
        sold: vehicles.filter(v => v.status === 'sold').length,
        pending: vehicles.filter(v => v.status === 'pending_review').length
    };

    document.getElementById('totalVehicles').textContent = stats.total;
    document.getElementById('listedVehicles').textContent = stats.listed;
    document.getElementById('soldVehicles').textContent = stats.sold;
    document.getElementById('pendingVehicles').textContent = stats.pending;
}

// æ˜¾ç¤ºç©ºçŠ¶æ€
function showEmptyState() {
    document.getElementById('emptyState').style.display = 'block';
}

// æ¸²æŸ“åˆ†é¡µ
function renderPagination() {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(totalVehicles / pageSize);

    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }

    pagination.style.display = 'flex';
    pagination.innerHTML = '';

    // ä¸Šä¸€é¡µæŒ‰é’®
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'ä¸Šä¸€é¡µ';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => changePage(currentPage - 1);
    pagination.appendChild(prevBtn);

    // é¡µç æŒ‰é’®
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? 'active' : '';
        pageBtn.onclick = () => changePage(i);
        pagination.appendChild(pageBtn);
    }

    // ä¸‹ä¸€é¡µæŒ‰é’®
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => changePage(currentPage + 1);
    pagination.appendChild(nextBtn);
}

// åˆ‡æ¢é¡µé¢
function changePage(page) {
    if (page < 1 || page > Math.ceil(totalVehicles / pageSize)) return;
    currentPage = page;
    loadVehicles();
}

// æŸ¥çœ‹è½¦è¾†
function viewVehicle(id) {
    window.open(`/vehicles/${id}/`, '_blank');
}

// ç¼–è¾‘è½¦è¾†
function editVehicle(id) {
    window.location.href = `/vehicles/${id}/edit/`;
}

// åˆ é™¤è½¦è¾†
async function deleteVehicle(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™è¾†è½¦å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
        return;
    }

    try {
        const response = await fetch(`/api/vehicles/${id}/`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('accessToken') || ''}`
            }
        });

        if (response.ok) {
            showSuccess('è½¦è¾†åˆ é™¤æˆåŠŸ');
            loadVehicles(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } else {
            throw new Error('åˆ é™¤å¤±è´¥');
        }
    } catch (error) {
        console.error('åˆ é™¤è½¦è¾†å¤±è´¥:', error);
        showError('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
function showSuccess(message) {
    showMessage('success', message);
}

// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
function showError(message) {
    showMessage('error', message);
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(type, message) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 4px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;

    if (type === 'success') {
        messageDiv.style.background = '#28a745';
    } else {
        messageDiv.style.background = '#dc3545';
    }

    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);

    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}
</script>
{% endblock %}